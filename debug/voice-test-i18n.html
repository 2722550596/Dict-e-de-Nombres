<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Test de Voix FranÃ§aise</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .button:hover {
            background-color: #0056b3;
        }
        
        .button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        select {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .voice-info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .voice-list {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .voice-list ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .voice-list li {
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .language-selector select {
            width: auto;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <select id="languageSelect">
            <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
            <option value="en">ğŸ‡ºğŸ‡¸ English</option>
            <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
        </select>
    </div>

    <div class="container">
        <h1 id="main-title">Test de Voix FranÃ§aise</h1>
        
        <div id="warning" class="warning"></div>
        <div id="info" class="info"></div>
        
        <div class="voice-info" id="savedVoiceStatus">
            <strong id="saved-voice-label">Voix sauvegardÃ©e actuelle:</strong>
            <span id="savedVoiceInfo"></span>
        </div>
    </div>
    
    <div class="container">
        <h2 id="voice-selection-title">SÃ©lection de Voix</h2>
        <label for="voiceSelect" id="select-voice-label">SÃ©lectionner une voix:</label>
        <select id="voiceSelect">
            <option id="loading-option">Chargement des voix...</option>
        </select>
        
        <div>
            <button class="button" id="testVoiceBtn" onclick="testFrenchVoice()" disabled>Tester la voix sÃ©lectionnÃ©e</button>
            <button class="button" id="saveVoiceBtn" onclick="saveSelectedVoice()" disabled>Sauvegarder la voix</button>
            <button class="button" id="clearVoiceBtn" onclick="clearSavedVoice()">Effacer la voix sauvegardÃ©e</button>
        </div>
    </div>
    
    <div class="container">
        <h2 id="test-section-title">Tests</h2>
        <button class="button" id="testAllBtn" onclick="testAllFrenchVoices()">Tester toutes les voix franÃ§aises</button>
        <button class="button" id="testNumbersBtn" onclick="testWithNumbers()">Tester avec des nombres</button>
        <button class="button" id="listVoicesBtn" onclick="listVoices()">Lister toutes les voix</button>

        <div id="voiceList" class="voice-list"></div>
    </div>

    <!-- æ–°å¢ï¼šæ··åˆå‘éŸ³ç³»ç»Ÿæµ‹è¯•åŒºåŸŸ -->
    <div class="container">
        <h2 id="enhanced-test-title">ğŸš€ Tests du SystÃ¨me de Prononciation AmÃ©liorÃ©</h2>

        <div class="enhanced-controls">
            <div style="margin-bottom: 15px;">
                <label for="pronunciationMethod" id="method-label">MÃ©thode de prononciation:</label>
                <select id="pronunciationMethod" onchange="updatePronunciationMethod()">
                    <option value="auto">Automatique (Google â†’ API â†’ TTS)</option>
                    <option value="google">Google TTS (Haute qualitÃ©)</option>
                    <option value="api">API Youdao (Backup)</option>
                    <option value="tts">SynthÃ¨se vocale (SystÃ¨me)</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label for="testText" id="text-label">Texte Ã  tester:</label>
                <input type="text" id="testText" value="vingt-trois" style="width: 200px; padding: 8px; margin: 0 10px;">
                <button class="button" onclick="testEnhancedPronunciation()">ğŸ”Š Tester</button>
            </div>

            <div style="margin-bottom: 15px;">
                <button class="button" onclick="testNumberSequence()">ğŸ”¢ Tester sÃ©quence de nombres</button>
                <button class="button" onclick="testMathOperations()">â• Tester opÃ©rations mathÃ©matiques</button>
                <button class="button" onclick="showCacheStats()">ğŸ“Š Statistiques du cache</button>
            </div>
        </div>

        <div id="enhancedInfo" class="info" style="display: none;"></div>
        <div id="enhancedWarning" class="warning" style="display: none;"></div>

        <!-- APIä½¿ç”¨è¯´æ˜ -->
        <div id="apiNotice" style="background: #e3f2fd; padding: 15px; border-radius: 4px; margin: 10px 0; border-left: 4px solid #2196f3;">
            <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“¡ APIä½¿ç”¨è¯´æ˜</h4>
            <p style="margin: 0 0 10px 0; font-size: 14px;">
                <strong>å¦‚æœAPIè¯·æ±‚å¤±è´¥</strong>ï¼Œè¿™æ˜¯ç”±äºCORSè·¨åŸŸé™åˆ¶å¯¼è‡´çš„ã€‚è§£å†³æ–¹æ¡ˆï¼š
            </p>
            <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                <li><strong>æ¨è</strong>: ä½¿ç”¨HTTPæœåŠ¡å™¨è®¿é—®é¡µé¢ (å¦‚ <code>python -m http.server 8000</code>)</li>
                <li><strong>ä¸´æ—¶</strong>: ç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•å¤šä¸ªä»£ç†æœåŠ¡</li>
                <li><strong>å›é€€</strong>: APIå¤±è´¥æ—¶ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°TTSæ¨¡å¼</li>
            </ul>
            <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                ğŸ’¡ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒAPIé€šè¿‡HTTPSæœåŠ¡å™¨è®¿é—®æ—¶å·¥ä½œæ­£å¸¸ã€‚
            </p>
        </div>

        <!-- çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="pronunciationStatus" style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0; display: none;">
            <h4>ğŸ“ˆ çŠ¶æ€ä¿¡æ¯</h4>
            <div id="statusContent"></div>
        </div>

        <!-- ç¼“å­˜ç»Ÿè®¡åŒºåŸŸ -->
        <div id="cacheStatsDisplay" style="background: #e7f3ff; padding: 15px; border-radius: 4px; margin: 10px 0; display: none;">
            <h4>ğŸ’¾ ç¼“å­˜ç»Ÿè®¡</h4>
            <div id="cacheStatsContent"></div>
        </div>
    </div>

    <script>
        // å†…åµŒç¿»è¯‘ç³»ç»Ÿ
        const TRANSLATIONS = {
            fr: {
                voiceTest: {
                    title: "Test de Voix FranÃ§aise",
                    browserNotSupported: "Votre navigateur ne supporte pas Web Speech API",
                    noFrenchVoiceDetected: "Aucune voix franÃ§aise dÃ©tectÃ©e. Sur iOS, allez dans RÃ©glages > AccessibilitÃ© > Contenu Ã©noncÃ© > Voix pour ajouter une voix franÃ§aise.",
                    iosVoiceInstructions: "Sur iOS, allez dans RÃ©glages > AccessibilitÃ© > Contenu Ã©noncÃ© > Voix pour ajouter une voix franÃ§aise.",
                    voiceListUpdated: "Liste des voix mise Ã  jour",
                    noFrenchVoiceAvailable: "Aucune voix franÃ§aise disponible",
                    noVoiceFound: "Aucune voix trouvÃ©e, veuillez rÃ©essayer plus tard",
                    speechSynthesisNotSupported: "Votre navigateur ne supporte pas la synthÃ¨se vocale",
                    noFrenchVoiceFoundUsingDefault: "Aucune voix franÃ§aise trouvÃ©e, utilisation de la voix par dÃ©faut",
                    speechError: "Erreur vocale",
                    readingStarted: "Lecture commencÃ©e",
                    readingFinished: "Lecture terminÃ©e",
                    testingAllFrenchVoices: "Test de toutes les voix franÃ§aises...",
                    availableVoices: "Voix disponibles:",
                    voicesDetected: "voix franÃ§aise(s) dÃ©tectÃ©e(s)",
                    currentSavedVoice: "Voix sauvegardÃ©e actuelle:",
                    selectVoice: "SÃ©lectionner une voix",
                    testSelectedVoice: "Tester la voix sÃ©lectionnÃ©e",
                    testAllVoices: "Tester toutes les voix franÃ§aises",
                    listAllVoices: "Lister toutes les voix",
                    saveVoice: "Sauvegarder la voix",
                    clearSavedVoice: "Effacer la voix sauvegardÃ©e",
                    testNumbers: "Tester avec des nombres",
                    usingVoice: "Utilisation de la voix",
                    // æ–°å¢ï¼šæ··åˆå‘éŸ³ç³»ç»Ÿ
                    enhancedTestTitle: "ğŸš€ Tests du SystÃ¨me de Prononciation AmÃ©liorÃ©",
                    pronunciationMethod: "MÃ©thode de prononciation:",
                    methodAuto: "Automatique (API + TTS)",
                    methodAPI: "API Youdao (Haute qualitÃ©)",
                    methodTTS: "SynthÃ¨se vocale (SystÃ¨me)",
                    testText: "Texte Ã  tester:",
                    testButton: "ğŸ”Š Tester",
                    testSequence: "ğŸ”¢ Tester sÃ©quence de nombres",
                    testMath: "â• Tester opÃ©rations mathÃ©matiques",
                    showStats: "ğŸ“Š Statistiques du cache"
                }
            },
            en: {
                voiceTest: {
                    title: "French Voice Test",
                    browserNotSupported: "Your browser does not support Web Speech API",
                    noFrenchVoiceDetected: "No French voice detected. On iOS, go to Settings > Accessibility > Spoken Content > Voices to add a French voice.",
                    iosVoiceInstructions: "On iOS, go to Settings > Accessibility > Spoken Content > Voices to add a French voice.",
                    voiceListUpdated: "Voice list updated",
                    noFrenchVoiceAvailable: "No French voice available",
                    noVoiceFound: "No voices found, please try again later",
                    speechSynthesisNotSupported: "Your browser does not support speech synthesis",
                    noFrenchVoiceFoundUsingDefault: "No French voice found, using default voice",
                    speechError: "Speech error",
                    readingStarted: "Reading started",
                    readingFinished: "Reading finished",
                    testingAllFrenchVoices: "Testing all French voices...",
                    availableVoices: "Available voices:",
                    voicesDetected: "French voice(s) detected",
                    currentSavedVoice: "Current saved voice:",
                    selectVoice: "Select a voice",
                    testSelectedVoice: "Test selected voice",
                    testAllVoices: "Test all French voices",
                    listAllVoices: "List all voices",
                    saveVoice: "Save voice",
                    clearSavedVoice: "Clear saved voice",
                    testNumbers: "Test with numbers",
                    usingVoice: "Using voice",
                    // æ–°å¢ï¼šæ··åˆå‘éŸ³ç³»ç»Ÿ
                    enhancedTestTitle: "ğŸš€ Enhanced Pronunciation System Tests",
                    pronunciationMethod: "Pronunciation method:",
                    methodAuto: "Auto (API + TTS)",
                    methodAPI: "Youdao API (High quality)",
                    methodTTS: "Text-to-Speech (System)",
                    testText: "Text to test:",
                    testButton: "ğŸ”Š Test",
                    testSequence: "ğŸ”¢ Test number sequence",
                    testMath: "â• Test math operations",
                    showStats: "ğŸ“Š Cache statistics"
                }
            },
            zh: {
                voiceTest: {
                    title: "æ³•è¯­è¯­éŸ³æµ‹è¯•",
                    browserNotSupported: "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Speech API",
                    noFrenchVoiceDetected: "æœªæ£€æµ‹åˆ°æ³•è¯­è¯­éŸ³ã€‚åœ¨iOSä¸Šï¼Œè¯·å‰å¾€è®¾ç½® > è¾…åŠ©åŠŸèƒ½ > æœ—è¯»å†…å®¹ > è¯­éŸ³æ¥æ·»åŠ æ³•è¯­è¯­éŸ³ã€‚",
                    iosVoiceInstructions: "åœ¨iOSä¸Šï¼Œè¯·å‰å¾€è®¾ç½® > è¾…åŠ©åŠŸèƒ½ > æœ—è¯»å†…å®¹ > è¯­éŸ³æ¥æ·»åŠ æ³•è¯­è¯­éŸ³ã€‚",
                    voiceListUpdated: "è¯­éŸ³åˆ—è¡¨å·²æ›´æ–°",
                    noFrenchVoiceAvailable: "æ²¡æœ‰å¯ç”¨çš„æ³•è¯­è¯­éŸ³",
                    noVoiceFound: "æœªæ‰¾åˆ°è¯­éŸ³ï¼Œè¯·ç¨åé‡è¯•",
                    speechSynthesisNotSupported: "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ",
                    noFrenchVoiceFoundUsingDefault: "æœªæ‰¾åˆ°æ³•è¯­è¯­éŸ³ï¼Œä½¿ç”¨é»˜è®¤è¯­éŸ³",
                    speechError: "è¯­éŸ³é”™è¯¯",
                    readingStarted: "å¼€å§‹æœ—è¯»",
                    readingFinished: "æœ—è¯»å®Œæˆ",
                    testingAllFrenchVoices: "æµ‹è¯•æ‰€æœ‰æ³•è¯­è¯­éŸ³...",
                    availableVoices: "å¯ç”¨è¯­éŸ³ï¼š",
                    voicesDetected: "æ£€æµ‹åˆ°æ³•è¯­è¯­éŸ³",
                    currentSavedVoice: "å½“å‰ä¿å­˜çš„è¯­éŸ³ï¼š",
                    selectVoice: "é€‰æ‹©è¯­éŸ³",
                    testSelectedVoice: "æµ‹è¯•é€‰ä¸­çš„è¯­éŸ³",
                    testAllVoices: "æµ‹è¯•æ‰€æœ‰æ³•è¯­è¯­éŸ³",
                    listAllVoices: "åˆ—å‡ºæ‰€æœ‰è¯­éŸ³",
                    saveVoice: "ä¿å­˜è¯­éŸ³",
                    clearSavedVoice: "æ¸…é™¤ä¿å­˜çš„è¯­éŸ³",
                    testNumbers: "ç”¨æ•°å­—æµ‹è¯•",
                    usingVoice: "ä½¿ç”¨è¯­éŸ³",
                    // æ–°å¢ï¼šæ··åˆå‘éŸ³ç³»ç»Ÿ
                    enhancedTestTitle: "ğŸš€ å¢å¼ºå‘éŸ³ç³»ç»Ÿæµ‹è¯•",
                    pronunciationMethod: "å‘éŸ³æ–¹å¼:",
                    methodAuto: "è‡ªåŠ¨ (API + TTS)",
                    methodAPI: "æœ‰é“API (é«˜è´¨é‡)",
                    methodTTS: "è¯­éŸ³åˆæˆ (ç³»ç»Ÿ)",
                    testText: "æµ‹è¯•æ–‡æœ¬:",
                    testButton: "ğŸ”Š æµ‹è¯•",
                    testSequence: "ğŸ”¢ æµ‹è¯•æ•°å­—åºåˆ—",
                    testMath: "â• æµ‹è¯•æ•°å­¦è¿ç®—",
                    showStats: "ğŸ“Š ç¼“å­˜ç»Ÿè®¡"
                }
            }
        };

        let currentLanguage = 'fr';
        let translations = TRANSLATIONS[currentLanguage];
        const loading = "Chargement des voix...";
        let selectedVoice = null;
        
        // æ›´æ–°é¡µé¢æ–‡æœ¬
        function updatePageTexts() {
            document.getElementById('page-title').textContent = translations.voiceTest.title;
            document.getElementById('main-title').textContent = translations.voiceTest.title;
            document.getElementById('saved-voice-label').textContent = translations.voiceTest.currentSavedVoice;
            document.getElementById('voice-selection-title').textContent = translations.voiceTest.selectVoice;
            document.getElementById('select-voice-label').textContent = translations.voiceTest.selectVoice + ':';
            document.getElementById('loading-option').textContent = loading;
            document.getElementById('testVoiceBtn').textContent = translations.voiceTest.testSelectedVoice;
            document.getElementById('saveVoiceBtn').textContent = translations.voiceTest.saveVoice;
            document.getElementById('clearVoiceBtn').textContent = translations.voiceTest.clearSavedVoice;
            document.getElementById('test-section-title').textContent = translations.voiceTest.testNumbers;
            document.getElementById('testAllBtn').textContent = translations.voiceTest.testAllVoices;
            document.getElementById('testNumbersBtn').textContent = translations.voiceTest.testNumbers;
            document.getElementById('listVoicesBtn').textContent = translations.voiceTest.listAllVoices;

            // æ›´æ–°å¢å¼ºå‘éŸ³ç³»ç»Ÿçš„ç¿»è¯‘
            const enhancedTitle = document.getElementById('enhanced-test-title');
            const methodLabel = document.getElementById('method-label');
            const textLabel = document.getElementById('text-label');

            if (enhancedTitle) enhancedTitle.textContent = translations.voiceTest.enhancedTestTitle;
            if (methodLabel) methodLabel.textContent = translations.voiceTest.pronunciationMethod;
            if (textLabel) textLabel.textContent = translations.voiceTest.testText;

            // æ›´æ–°é€‰æ‹©æ¡†é€‰é¡¹
            const methodSelect = document.getElementById('pronunciationMethod');
            if (methodSelect) {
                methodSelect.options[0].textContent = translations.voiceTest.methodAuto;
                methodSelect.options[1].textContent = translations.voiceTest.methodAPI;
                methodSelect.options[2].textContent = translations.voiceTest.methodTTS;
            }
        }
        
        // è¯­è¨€åˆ‡æ¢
        document.getElementById('languageSelect').addEventListener('change', (e) => {
            currentLanguage = e.target.value;
            translations = TRANSLATIONS[currentLanguage];
            updatePageTexts();
            localStorage.setItem('selectedLanguage', currentLanguage);
        });
        
        // æ¢å¤ä¿å­˜çš„è¯­è¨€
        const savedLanguage = localStorage.getItem('selectedLanguage');
        if (savedLanguage && TRANSLATIONS[savedLanguage]) {
            currentLanguage = savedLanguage;
            translations = TRANSLATIONS[currentLanguage];
            document.getElementById('languageSelect').value = savedLanguage;
            updatePageTexts();
        }
        
        function showWarning(message) {
            const warning = document.getElementById('warning');
            warning.textContent = message;
            warning.style.display = 'block';
        }
        
        function showInfo(message) {
            const info = document.getElementById('info');
            info.textContent = message;
            info.style.display = 'block';
        }
        
        function clearMessages() {
            document.getElementById('warning').style.display = 'none';
            document.getElementById('info').style.display = 'none';
        }
        
        function getAllFrenchVoices() {
            if (!window.speechSynthesis) return [];
            
            const voices = window.speechSynthesis.getVoices();
            
            return voices.filter(voice => {
                const isFrench = /fr/i.test(voice.lang) || /french/i.test(voice.name);
                return isFrench;
            });
        }
        
        function getFrenchVoice() {
            const frenchVoices = getAllFrenchVoices();
            
            try {
                const savedVoiceData = localStorage.getItem('selectedFrenchVoice');
                if (savedVoiceData) {
                    const voiceData = JSON.parse(savedVoiceData);
                    const matchingVoice = frenchVoices.find(voice =>
                        voice.voiceURI === voiceData.voiceURI ||
                        (voice.name === voiceData.name && voice.lang === voiceData.lang)
                    );
                    if (matchingVoice) {
                        return matchingVoice;
                    }
                }
            } catch (error) {
                console.warn('Error loading saved voice:', error);
            }
            
            return frenchVoices.length > 0 ? frenchVoices[0] : null;
        }
        
        function populateVoiceSelector() {
            const select = document.getElementById('voiceSelect');
            const frenchVoices = getAllFrenchVoices();
            
            select.innerHTML = '';
            
            frenchVoices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                select.appendChild(option);
            });

            if (frenchVoices.length === 0) {
                const option = document.createElement('option');
                option.textContent = translations.voiceTest.noFrenchVoiceAvailable;
                option.disabled = true;
                select.appendChild(option);
            }

            restoreSavedVoice();
            updateButtonStates();
            updateSavedVoiceStatus();
        }
        
        // å°†å…¨å±€å‡½æ•°æš´éœ²åˆ°windowå¯¹è±¡
        window.testFrenchVoice = testFrenchVoice;
        window.saveSelectedVoice = saveSelectedVoice;
        window.clearSavedVoice = clearSavedVoice;
        window.testAllFrenchVoices = testAllFrenchVoices;
        window.testWithNumbers = testWithNumbers;
        window.listVoices = listVoices;
        
        function restoreSavedVoice() {
            try {
                const savedVoiceData = localStorage.getItem('selectedFrenchVoice');
                if (savedVoiceData) {
                    const voiceData = JSON.parse(savedVoiceData);
                    const frenchVoices = getAllFrenchVoices();
                    const select = document.getElementById('voiceSelect');

                    const matchingVoiceIndex = frenchVoices.findIndex(voice =>
                        voice.voiceURI === voiceData.voiceURI ||
                        (voice.name === voiceData.name && voice.lang === voiceData.lang)
                    );

                    if (matchingVoiceIndex !== -1) {
                        select.selectedIndex = matchingVoiceIndex;
                        selectedVoice = frenchVoices[matchingVoiceIndex];
                    }
                }
            } catch (error) {
                console.warn('Error restoring saved voice:', error);
            }
        }

        function updateButtonStates() {
            const frenchVoices = getAllFrenchVoices();
            const hasVoices = frenchVoices.length > 0;

            document.getElementById('testVoiceBtn').disabled = !hasVoices;
            document.getElementById('saveVoiceBtn').disabled = !hasVoices;
        }

        function updateSavedVoiceStatus() {
            const statusDiv = document.getElementById('savedVoiceStatus');
            const infoSpan = document.getElementById('savedVoiceInfo');

            try {
                const savedVoiceData = localStorage.getItem('selectedFrenchVoice');
                if (savedVoiceData) {
                    const voiceData = JSON.parse(savedVoiceData);
                    infoSpan.textContent = `${voiceData.name} (${voiceData.lang})`;
                    statusDiv.style.display = 'block';
                } else {
                    statusDiv.style.display = 'none';
                }
            } catch (error) {
                statusDiv.style.display = 'none';
            }
        }

        function saveSelectedVoice() {
            const select = document.getElementById('voiceSelect');
            const frenchVoices = getAllFrenchVoices();

            if (select.selectedIndex >= 0 && select.selectedIndex < frenchVoices.length) {
                const selectedVoice = frenchVoices[select.selectedIndex];
                const voiceData = {
                    name: selectedVoice.name,
                    lang: selectedVoice.lang,
                    voiceURI: selectedVoice.voiceURI
                };

                localStorage.setItem('selectedFrenchVoice', JSON.stringify(voiceData));
                showInfo(`${translations.voiceTest.saveVoice}: ${selectedVoice.name} (${selectedVoice.lang})`);
                updateSavedVoiceStatus();
            }
        }

        function clearSavedVoice() {
            localStorage.removeItem('selectedFrenchVoice');
            showInfo(translations.voiceTest.clearSavedVoice);
            updateSavedVoiceStatus();
        }

        function testFrenchVoice() {
            if (!window.speechSynthesis) {
                showWarning(translations.voiceTest.speechSynthesisNotSupported);
                return;
            }

            clearMessages();

            const utterance = new SpeechSynthesisUtterance('Bonjour, je teste la voix franÃ§aise. Les nombres: vingt-trois, quarante-sept, soixante-dix-huit.');
            utterance.lang = 'fr-FR';

            const frenchVoice = getFrenchVoice();
            if (frenchVoice) {
                utterance.voice = frenchVoice;
                showInfo(`${translations.voiceTest.usingVoice}: ${frenchVoice.name} (${frenchVoice.lang})`);
            } else {
                showWarning(translations.voiceTest.noFrenchVoiceFoundUsingDefault);
            }

            utterance.onerror = (event) => {
                showWarning(`${translations.voiceTest.speechError}: ${event.error}`);
            };

            utterance.onstart = () => {
                console.log(translations.voiceTest.readingStarted);
            };

            utterance.onend = () => {
                console.log(translations.voiceTest.readingFinished);
            };

            window.speechSynthesis.speak(utterance);
        }

        function testWithNumbers() {
            if (!window.speechSynthesis) {
                showWarning(translations.voiceTest.speechSynthesisNotSupported);
                return;
            }

            clearMessages();

            const numbers = ['quinze', 'vingt-trois', 'quarante-sept', 'soixante-dix-huit', 'quatre-vingt-douze'];
            const text = `${translations.voiceTest.testNumbers}: ${numbers.join(', ')}.`;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR';

            const frenchVoice = getFrenchVoice();
            if (frenchVoice) {
                utterance.voice = frenchVoice;
                showInfo(`${translations.voiceTest.usingVoice}: ${frenchVoice.name} (${frenchVoice.lang})`);
            } else {
                showWarning(translations.voiceTest.noFrenchVoiceFoundUsingDefault);
            }

            window.speechSynthesis.speak(utterance);
        }

        function testAllFrenchVoices() {
            const frenchVoices = getAllFrenchVoices();
            if (frenchVoices.length === 0) {
                showWarning(translations.voiceTest.noFrenchVoiceAvailable);
                return;
            }

            clearMessages();
            showInfo(translations.voiceTest.testingAllFrenchVoices);

            let currentIndex = 0;

            function testNextVoice() {
                if (currentIndex >= frenchVoices.length) {
                    showInfo(`${translations.voiceTest.testCompleted || 'Test terminÃ©'}`);
                    return;
                }

                const voice = frenchVoices[currentIndex];
                const utterance = new SpeechSynthesisUtterance(`Voix ${currentIndex + 1}: ${voice.name}. Bonjour, vingt-trois.`);
                utterance.voice = voice;
                utterance.lang = 'fr-FR';

                utterance.onend = () => {
                    currentIndex++;
                    setTimeout(testNextVoice, 1000);
                };

                utterance.onerror = () => {
                    currentIndex++;
                    setTimeout(testNextVoice, 500);
                };

                window.speechSynthesis.speak(utterance);
            }

            testNextVoice();
        }

        function listVoices() {
            const voiceList = document.getElementById('voiceList');
            const voices = window.speechSynthesis.getVoices();

            if (voices.length === 0) {
                voiceList.innerHTML = `<p>${translations.voiceTest.noVoiceFound}</p>`;
                voiceList.style.display = 'block';
                return;
            }

            let html = `<h3>${translations.voiceTest.availableVoices}</h3><ul>`;
            voices.forEach((voice, index) => {
                const isFrench = /fr/i.test(voice.lang) || /french/i.test(voice.name);
                const marker = isFrench ? 'ğŸ‡«ğŸ‡· ' : '';
                html += `<li>${marker}${voice.name} (${voice.lang}) - ${voice.voiceURI}</li>`;
            });
            html += '</ul>';

            voiceList.innerHTML = html;
            voiceList.style.display = 'block';
        }

        window.addEventListener('load', () => {
            if (!window.speechSynthesis) {
                showWarning(translations.voiceTest.browserNotSupported);
                return;
            }

            function checkVoices() {
                const voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) {
                    setTimeout(checkVoices, 100);
                    return;
                }

                populateVoiceSelector();

                const frenchVoices = getAllFrenchVoices();
                if (frenchVoices.length === 0) {
                    showWarning(translations.voiceTest.noFrenchVoiceDetected);
                } else {
                    showInfo(`${frenchVoices.length} ${translations.voiceTest.voicesDetected}`);
                }
            }

            checkVoices();
        });

        window.speechSynthesis.onvoiceschanged = () => {
            console.log(translations.voiceTest.voiceListUpdated);
            populateVoiceSelector();
        };

        // ========== æ··åˆå‘éŸ³ç³»ç»Ÿæµ‹è¯•åŠŸèƒ½ ==========

        // ç®€åŒ–ç‰ˆçš„å‘éŸ³ç®¡ç†å™¨ï¼ˆç”¨äºæµ‹è¯•ï¼‰
        class TestPronunciationManager {
            constructor() {
                this.config = {
                    preferredMethod: 'auto',
                    timeout: 5000,
                    volume: 1
                };
                this.cache = new Map();
                this.stats = {
                    totalRequests: 0,
                    cacheHits: 0,
                    googleTtsSuccess: 0,
                    apiSuccess: 0,
                    ttsSuccess: 0
                };
            }

            // ç”ŸæˆGoogle TTS URL
            generateGoogleTtsUrl(text) {
                // Google Translate TTS API
                const baseUrl = 'https://translate.google.com/translate_tts';
                const params = new URLSearchParams({
                    ie: 'UTF-8',
                    q: text,
                    tl: 'fr', // æ³•è¯­
                    client: 'tw-ob',
                    ttsspeed: '1' // æ­£å¸¸è¯­é€Ÿ
                });

                // æ£€æµ‹ç¯å¢ƒå¹¶å†³å®šæ˜¯å¦ä½¿ç”¨ä»£ç†
                const isHttpServer = window.location.protocol === 'http:' && window.location.hostname === 'localhost';
                const directUrl = `${baseUrl}?${params.toString()}`;

                if (isHttpServer) {
                    // HTTPç¯å¢ƒï¼šç›´æ¥å°è¯•
                    return directUrl;
                } else {
                    // file://ç¯å¢ƒï¼šä½¿ç”¨ä»£ç†
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    return proxyUrl + encodeURIComponent(directUrl);
                }
            }

            // ç”Ÿæˆæœ‰é“API URL (ä¿ç•™ä½œä¸ºå¤‡é€‰)
            generateYoudaoUrl(text) {
                // æ£€æµ‹æ˜¯å¦é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®
                const isHttpServer = window.location.protocol === 'http:' && window.location.hostname === 'localhost';

                if (isHttpServer) {
                    // HTTPæœåŠ¡å™¨ç¯å¢ƒï¼šç›´æ¥è®¿é—®API
                    return `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&le=fr`;
                } else {
                    // file:// åè®®ï¼šä½¿ç”¨CORSä»£ç†
                    const proxyUrl = 'https://api.allorigins.win/raw?url=';
                    const apiUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&le=fr`;
                    return proxyUrl + encodeURIComponent(apiUrl);
                }
            }

            // Google TTSæ’­æ”¾æ–¹æ³•
            async playWithGoogleTTS(text) {
                try {
                    // æ£€æŸ¥ç¼“å­˜
                    if (this.cache.has(`google_${text}`)) {
                        const audio = this.cache.get(`google_${text}`);
                        audio.currentTime = 0;
                        await this.playAudio(audio);
                        this.stats.cacheHits++;
                        return { success: true, method: 'google', fromCache: true };
                    }

                    // å°è¯•å¤šä¸ªä»£ç†æœåŠ¡
                    const isHttpServer = window.location.protocol === 'http:' && window.location.hostname === 'localhost';
                    const proxies = isHttpServer ? [
                        '', // HTTPç¯å¢ƒï¼šä¼˜å…ˆç›´æ¥è®¿é—®
                        'https://api.allorigins.win/raw?url=',
                        'https://cors-anywhere.herokuapp.com/'
                    ] : [
                        'https://api.allorigins.win/raw?url=',
                        'https://cors-anywhere.herokuapp.com/',
                        '' // file://ç¯å¢ƒï¼šæœ€åå°è¯•ç›´æ¥è®¿é—®
                    ];

                    let lastError = null;

                    for (let i = 0; i < proxies.length; i++) {
                        try {
                            const url = this.generateGoogleTtsUrlWithProxy(text, proxies[i]);
                            console.log(`ğŸ”„ å°è¯•Google TTSä»£ç† ${i + 1}/${proxies.length}: ${proxies[i] || 'ç›´æ¥è®¿é—®'}`);

                            const audio = await this.loadAudio(url);

                            // ç¼“å­˜éŸ³é¢‘
                            this.cache.set(`google_${text}`, audio);

                            // æ’­æ”¾éŸ³é¢‘
                            await this.playAudio(audio);
                            this.stats.googleTtsSuccess++;
                            console.log(`âœ… Google TTSä»£ç† ${i + 1} æˆåŠŸ`);
                            return { success: true, method: 'google', fromCache: false };
                        } catch (error) {
                            console.warn(`âŒ Google TTSä»£ç† ${i + 1} å¤±è´¥:`, error.message);
                            lastError = error;
                            continue;
                        }
                    }

                    // æ‰€æœ‰ä»£ç†éƒ½å¤±è´¥
                    throw lastError || new Error('æ‰€æœ‰Google TTSä»£ç†éƒ½å¤±è´¥');
                } catch (error) {
                    console.error('Google TTSæ’­æ”¾å¤±è´¥:', error);
                    return { success: false, method: 'google', error: error.message };
                }
            }

            // ä½¿ç”¨æŒ‡å®šä»£ç†ç”ŸæˆGoogle TTS URL
            generateGoogleTtsUrlWithProxy(text, proxy) {
                const baseUrl = 'https://translate.google.com/translate_tts';
                const params = new URLSearchParams({
                    ie: 'UTF-8',
                    q: text,
                    tl: 'fr',
                    client: 'tw-ob',
                    ttsspeed: '1'
                });
                const directUrl = `${baseUrl}?${params.toString()}`;

                if (!proxy) {
                    return directUrl; // ç›´æ¥è®¿é—®
                } else if (proxy.includes('allorigins')) {
                    return proxy + encodeURIComponent(directUrl);
                } else {
                    return proxy + directUrl;
                }
            }

            // APIæ’­æ”¾æ–¹æ³• (æœ‰é“APIï¼Œä¿ç•™ä½œä¸ºå¤‡é€‰)
            async playWithAPI(text) {
                try {
                    // æ£€æŸ¥ç¼“å­˜
                    if (this.cache.has(text)) {
                        const audio = this.cache.get(text);
                        audio.currentTime = 0;
                        await this.playAudio(audio);
                        this.stats.cacheHits++;
                        return { success: true, method: 'api', fromCache: true };
                    }

                    // æ ¹æ®ç¯å¢ƒé€‰æ‹©ä»£ç†ç­–ç•¥
                    const isHttpServer = window.location.protocol === 'http:' && window.location.hostname === 'localhost';
                    const proxies = isHttpServer ? [
                        '', // HTTPç¯å¢ƒï¼šä¼˜å…ˆç›´æ¥è®¿é—®
                        'https://api.allorigins.win/raw?url=',
                        'https://cors-anywhere.herokuapp.com/'
                    ] : [
                        'https://api.allorigins.win/raw?url=',
                        'https://cors-anywhere.herokuapp.com/',
                        '' // file://ç¯å¢ƒï¼šæœ€åå°è¯•ç›´æ¥è®¿é—®
                    ];

                    let lastError = null;

                    for (let i = 0; i < proxies.length; i++) {
                        try {
                            const url = this.generateYoudaoUrlWithProxy(text, proxies[i]);
                            console.log(`ğŸ”„ å°è¯•ä»£ç† ${i + 1}/${proxies.length}: ${proxies[i] || 'ç›´æ¥è®¿é—®'}`);

                            const audio = await this.loadAudio(url);

                            // ç¼“å­˜éŸ³é¢‘
                            this.cache.set(text, audio);

                            // æ’­æ”¾éŸ³é¢‘
                            await this.playAudio(audio);
                            this.stats.apiSuccess++;
                            console.log(`âœ… ä»£ç† ${i + 1} æˆåŠŸ`);
                            return { success: true, method: 'api', fromCache: false };
                        } catch (error) {
                            console.warn(`âŒ ä»£ç† ${i + 1} å¤±è´¥:`, error.message);
                            lastError = error;
                            continue;
                        }
                    }

                    // æ‰€æœ‰ä»£ç†éƒ½å¤±è´¥
                    throw lastError || new Error('æ‰€æœ‰APIä»£ç†éƒ½å¤±è´¥');
                } catch (error) {
                    console.error('APIæ’­æ”¾å¤±è´¥:', error);
                    return { success: false, method: 'api', error: error.message };
                }
            }

            // ä½¿ç”¨æŒ‡å®šä»£ç†ç”ŸæˆURL
            generateYoudaoUrlWithProxy(text, proxy) {
                const apiUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&le=fr`;

                if (!proxy) {
                    return apiUrl; // ç›´æ¥è®¿é—®
                } else if (proxy.includes('allorigins')) {
                    return proxy + encodeURIComponent(apiUrl);
                } else {
                    return proxy + apiUrl;
                }
            }

            // TTSæ’­æ”¾æ–¹æ³•
            async playWithTTS(text) {
                try {
                    console.log('ğŸ”Š TTSæ’­æ”¾å¼€å§‹:', text);

                    if (!window.speechSynthesis) {
                        throw new Error('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
                    }

                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'fr-FR';
                    utterance.volume = this.config.volume;
                    utterance.rate = 0.9;
                    utterance.pitch = 1.1;

                    // è·å–æœ€ä½³æ³•è¯­è¯­éŸ³
                    const voice = getFrenchVoice();
                    console.log('ğŸ¤ é€‰æ‹©çš„è¯­éŸ³:', voice ? voice.name : 'é»˜è®¤è¯­éŸ³');
                    if (voice) {
                        utterance.voice = voice;
                    }

                    console.log('ğŸ”Š å¼€å§‹TTSæ’­æ”¾...');
                    await this.speakTTS(utterance);
                    console.log('âœ… TTSæ’­æ”¾æˆåŠŸ');
                    this.stats.ttsSuccess++;
                    return { success: true, method: 'tts', fromCache: false };
                } catch (error) {
                    console.error('âŒ TTSæ’­æ”¾å¤±è´¥:', error);
                    return { success: false, method: 'tts', error: error.message };
                }
            }

            // ä¸»æ’­æ”¾æ–¹æ³•
            async playPronunciation(text) {
                this.stats.totalRequests++;

                let result;
                const method = this.config.preferredMethod;

                console.log(`ğŸµ å¼€å§‹æ’­æ”¾: "${text}", æ–¹æ³•: ${method}`);

                if (method === 'google') {
                    // çº¯Google TTSæ¨¡å¼
                    console.log('ğŸ”Š ä½¿ç”¨Google TTSæ’­æ”¾...');
                    result = await this.playWithGoogleTTS(text);
                    console.log('ğŸ”Š Google TTSç»“æœ:', result);
                } else if (method === 'api') {
                    // çº¯æœ‰é“APIæ¨¡å¼
                    console.log('ğŸ“¡ å°è¯•æœ‰é“APIæ’­æ”¾...');
                    result = await this.playWithAPI(text);
                    console.log('ğŸ“¡ APIç»“æœ:', result);
                } else if (method === 'tts') {
                    // çº¯ç³»ç»ŸTTSæ¨¡å¼
                    console.log('ğŸ”Š ç›´æ¥ä½¿ç”¨ç³»ç»ŸTTSæ’­æ”¾...');
                    result = await this.playWithTTS(text);
                    console.log('ğŸ”Š TTSç»“æœ:', result);
                } else if (method === 'auto') {
                    // è‡ªåŠ¨æ¨¡å¼ï¼šGoogle TTS â†’ æœ‰é“API â†’ ç³»ç»ŸTTS
                    console.log('ğŸ”Š å°è¯•Google TTSæ’­æ”¾...');
                    result = await this.playWithGoogleTTS(text);
                    console.log('ğŸ”Š Google TTSç»“æœ:', result);

                    if (!result.success) {
                        console.log('ğŸ”„ Google TTSå¤±è´¥ï¼Œå°è¯•æœ‰é“API...');
                        showEnhancedInfo('Google TTSå¤±è´¥ï¼Œå°è¯•æœ‰é“API...');
                        result = await this.playWithAPI(text);
                        console.log('ğŸ“¡ APIç»“æœ:', result);

                        if (!result.success) {
                            console.log('ğŸ”„ APIä¹Ÿå¤±è´¥ï¼Œå›é€€åˆ°ç³»ç»ŸTTS...');
                            showEnhancedInfo('APIå¤±è´¥ï¼Œå›é€€åˆ°ç³»ç»ŸTTS...');
                            result = await this.playWithTTS(text);
                            console.log('ğŸ”Š ç³»ç»ŸTTSç»“æœ:', result);
                        }
                    }
                }

                console.log('âœ… æœ€ç»ˆç»“æœ:', result);
                return result;
            }

            // åŠ è½½éŸ³é¢‘
            async loadAudio(url) {
                return new Promise((resolve, reject) => {
                    const audio = new Audio();
                    const timeoutId = setTimeout(() => {
                        reject(new Error('éŸ³é¢‘åŠ è½½è¶…æ—¶'));
                    }, this.config.timeout);

                    audio.oncanplaythrough = () => {
                        clearTimeout(timeoutId);
                        resolve(audio);
                    };

                    audio.onerror = () => {
                        clearTimeout(timeoutId);
                        reject(new Error('éŸ³é¢‘åŠ è½½å¤±è´¥'));
                    };

                    audio.crossOrigin = 'anonymous';
                    audio.src = url;
                    audio.load();
                });
            }

            // æ’­æ”¾éŸ³é¢‘
            async playAudio(audio) {
                return new Promise((resolve, reject) => {
                    audio.onended = resolve;
                    audio.onerror = () => reject(new Error('éŸ³é¢‘æ’­æ”¾å¤±è´¥'));
                    audio.play().catch(reject);
                });
            }

            // TTSæ’­æ”¾
            async speakTTS(utterance) {
                return new Promise((resolve, reject) => {
                    console.log('ğŸ™ï¸ è®¾ç½®TTSäº‹ä»¶ç›‘å¬å™¨...');

                    utterance.onstart = () => {
                        console.log('â–¶ï¸ TTSå¼€å§‹æ’­æ”¾');
                    };

                    utterance.onend = () => {
                        console.log('â¹ï¸ TTSæ’­æ”¾ç»“æŸ');
                        resolve();
                    };

                    utterance.onerror = (event) => {
                        console.error('âŒ TTSæ’­æ”¾é”™è¯¯:', event.error);
                        if (event.error !== 'canceled' && event.error !== 'interrupted') {
                            reject(new Error(`TTSé”™è¯¯: ${event.error}`));
                        } else {
                            console.log('â„¹ï¸ TTSè¢«å–æ¶ˆæˆ–ä¸­æ–­ï¼Œè§†ä¸ºæˆåŠŸ');
                            resolve();
                        }
                    };

                    console.log('ğŸ”„ å–æ¶ˆä¹‹å‰çš„TTSæ’­æ”¾...');
                    window.speechSynthesis.cancel();

                    console.log('ğŸµ å¼€å§‹æ–°çš„TTSæ’­æ”¾...');
                    window.speechSynthesis.speak(utterance);

                    // æ·»åŠ è¶…æ—¶ä¿æŠ¤
                    setTimeout(() => {
                        if (window.speechSynthesis.speaking) {
                            console.warn('âš ï¸ TTSæ’­æ”¾è¶…æ—¶ï¼Œå¼ºåˆ¶ç»“æŸ');
                            window.speechSynthesis.cancel();
                            resolve(); // è¶…æ—¶ä¹Ÿè§†ä¸ºæˆåŠŸï¼Œé¿å…å¡ä½
                        }
                    }, 10000); // 10ç§’è¶…æ—¶
                });
            }

            // è·å–ç»Ÿè®¡ä¿¡æ¯
            getStats() {
                const hitRate = this.stats.totalRequests > 0 ?
                    (this.stats.cacheHits / this.stats.totalRequests * 100).toFixed(1) : 0;

                return {
                    ...this.stats,
                    cacheSize: this.cache.size,
                    hitRate: hitRate + '%'
                };
            }

            // æ¸…é™¤ç¼“å­˜
            clearCache() {
                this.cache.clear();
            }

            // æ›´æ–°é…ç½®
            updateConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
            }
        }

        // åˆ›å»ºæµ‹è¯•ç®¡ç†å™¨å®ä¾‹
        const testPronunciationManager = new TestPronunciationManager();

        // UIè¾…åŠ©å‡½æ•°
        function showEnhancedInfo(message) {
            const info = document.getElementById('enhancedInfo');
            info.textContent = message;
            info.style.display = 'block';

            const warning = document.getElementById('enhancedWarning');
            warning.style.display = 'none';
        }

        function showEnhancedWarning(message) {
            const warning = document.getElementById('enhancedWarning');
            warning.textContent = message;
            warning.style.display = 'block';

            const info = document.getElementById('enhancedInfo');
            info.style.display = 'none';
        }

        function clearEnhancedMessages() {
            document.getElementById('enhancedInfo').style.display = 'none';
            document.getElementById('enhancedWarning').style.display = 'none';
        }

        // æ›´æ–°å‘éŸ³æ–¹æ³•
        function updatePronunciationMethod() {
            const select = document.getElementById('pronunciationMethod');
            const method = select.value;
            testPronunciationManager.updateConfig({ preferredMethod: method });
            showEnhancedInfo(`å‘éŸ³æ–¹æ³•å·²åˆ‡æ¢åˆ°: ${select.options[select.selectedIndex].text}`);
        }

        // æµ‹è¯•å¢å¼ºå‘éŸ³åŠŸèƒ½
        async function testEnhancedPronunciation() {
            const textInput = document.getElementById('testText');
            const text = textInput.value.trim();

            if (!text) {
                showEnhancedWarning('è¯·è¾“å…¥è¦æµ‹è¯•çš„æ–‡æœ¬');
                return;
            }

            clearEnhancedMessages();
            showEnhancedInfo('æ­£åœ¨æ’­æ”¾...');

            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•å‘éŸ³:', text);
            const startTime = Date.now();

            try {
                const result = await testPronunciationManager.playPronunciation(text);
                const duration = Date.now() - startTime;

                console.log('ğŸ§ª æµ‹è¯•ç»“æœ:', result);

                if (result.success) {
                    const cacheText = result.fromCache ? ' (æ¥è‡ªç¼“å­˜)' : '';
                    const methodText = result.method === 'api' ? 'API Youdao' : 'ç³»ç»ŸTTS';
                    showEnhancedInfo(`âœ… æ’­æ”¾æˆåŠŸï¼æ–¹æ³•: ${methodText}${cacheText}, è€—æ—¶: ${duration}ms`);
                } else {
                    showEnhancedWarning(`âŒ æ’­æ”¾å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                    console.error('ğŸ§ª æ’­æ”¾å¤±è´¥è¯¦æƒ…:', result);
                }

                updateStatusDisplay();
            } catch (error) {
                console.error('ğŸ§ª æµ‹è¯•å¼‚å¸¸:', error);
                showEnhancedWarning(`âŒ æ’­æ”¾é”™è¯¯: ${error.message}`);
                updateStatusDisplay();
            }
        }

        // æµ‹è¯•æ•°å­—åºåˆ—
        async function testNumberSequence() {
            const numbers = ['quinze', 'vingt-trois', 'quarante-sept', 'soixante-dix-huit', 'quatre-vingt-douze'];

            clearEnhancedMessages();
            showEnhancedInfo('æ­£åœ¨æµ‹è¯•æ•°å­—åºåˆ—...');

            let successCount = 0;
            let totalTime = 0;

            for (let i = 0; i < numbers.length; i++) {
                const number = numbers[i];
                showEnhancedInfo(`æ­£åœ¨æ’­æ”¾: ${number} (${i + 1}/${numbers.length})`);

                const startTime = Date.now();
                try {
                    const result = await testPronunciationManager.playPronunciation(number);
                    const duration = Date.now() - startTime;
                    totalTime += duration;

                    if (result.success) {
                        successCount++;
                    }

                    // æ’­æ”¾é—´éš”
                    if (i < numbers.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 800));
                    }
                } catch (error) {
                    console.warn(`æ•°å­— ${number} æ’­æ”¾å¤±è´¥:`, error);
                }
            }

            const avgTime = Math.round(totalTime / numbers.length);
            showEnhancedInfo(`âœ… æ•°å­—åºåˆ—æµ‹è¯•å®Œæˆï¼æˆåŠŸ: ${successCount}/${numbers.length}, å¹³å‡è€—æ—¶: ${avgTime}ms`);
            updateStatusDisplay();
        }

        // æµ‹è¯•æ•°å­¦è¿ç®—
        async function testMathOperations() {
            const operations = [
                'quinze plus huit',
                'vingt-trois moins sept',
                'quatre fois six',
                'trente-six divisÃ© par quatre'
            ];

            clearEnhancedMessages();
            showEnhancedInfo('æ­£åœ¨æµ‹è¯•æ•°å­¦è¿ç®—...');

            let successCount = 0;

            for (let i = 0; i < operations.length; i++) {
                const operation = operations[i];
                showEnhancedInfo(`æ­£åœ¨æ’­æ”¾: ${operation} (${i + 1}/${operations.length})`);

                try {
                    const result = await testPronunciationManager.playPronunciation(operation);
                    if (result.success) {
                        successCount++;
                    }

                    // æ’­æ”¾é—´éš”
                    if (i < operations.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                } catch (error) {
                    console.warn(`è¿ç®— ${operation} æ’­æ”¾å¤±è´¥:`, error);
                }
            }

            showEnhancedInfo(`âœ… æ•°å­¦è¿ç®—æµ‹è¯•å®Œæˆï¼æˆåŠŸ: ${successCount}/${operations.length}`);
            updateStatusDisplay();
        }

        // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
        function showCacheStats() {
            const stats = testPronunciationManager.getStats();
            const display = document.getElementById('cacheStatsDisplay');
            const content = document.getElementById('cacheStatsContent');

            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><strong>æ€»è¯·æ±‚æ•°:</strong> ${stats.totalRequests}</div>
                    <div><strong>ç¼“å­˜å‘½ä¸­:</strong> ${stats.cacheHits}</div>
                    <div><strong>Google TTSæˆåŠŸ:</strong> ${stats.googleTtsSuccess}</div>
                    <div><strong>æœ‰é“APIæˆåŠŸ:</strong> ${stats.apiSuccess}</div>
                    <div><strong>ç³»ç»ŸTTSæˆåŠŸ:</strong> ${stats.ttsSuccess}</div>
                    <div><strong>ç¼“å­˜å¤§å°:</strong> ${stats.cacheSize} é¡¹</div>
                    <div><strong>å‘½ä¸­ç‡:</strong> ${stats.hitRate}</div>
                </div>
                <div style="margin-top: 10px;">
                    <button class="button" onclick="clearTestCache()" style="background-color: #dc3545;">æ¸…é™¤ç¼“å­˜</button>
                </div>
            `;

            display.style.display = 'block';
        }

        // æ¸…é™¤æµ‹è¯•ç¼“å­˜
        function clearTestCache() {
            testPronunciationManager.clearCache();
            showEnhancedInfo('âœ… ç¼“å­˜å·²æ¸…é™¤');
            showCacheStats(); // åˆ·æ–°ç»Ÿè®¡æ˜¾ç¤º
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay() {
            const display = document.getElementById('pronunciationStatus');
            const content = document.getElementById('statusContent');
            const stats = testPronunciationManager.getStats();

            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 24px; color: #007bff;">${stats.totalRequests}</div>
                        <div style="font-size: 12px; color: #666;">æ€»è¯·æ±‚</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; color: #28a745;">${stats.googleTtsSuccess}</div>
                        <div style="font-size: 12px; color: #666;">Google TTS</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; color: #ffc107;">${stats.apiSuccess}</div>
                        <div style="font-size: 12px; color: #666;">æœ‰é“API</div>
                    </div>
                    <div>
                        <div style="font-size: 24px; color: #17a2b8;">${stats.ttsSuccess}</div>
                        <div style="font-size: 12px; color: #666;">ç³»ç»ŸTTS</div>
                    </div>
                </div>
            `;

            display.style.display = 'block';
        }

        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case 'Enter':
                        event.preventDefault();
                        testEnhancedPronunciation();
                        break;
                    case '1':
                        event.preventDefault();
                        document.getElementById('pronunciationMethod').value = 'auto';
                        updatePronunciationMethod();
                        break;
                    case '2':
                        event.preventDefault();
                        document.getElementById('pronunciationMethod').value = 'api';
                        updatePronunciationMethod();
                        break;
                    case '3':
                        event.preventDefault();
                        document.getElementById('pronunciationMethod').value = 'tts';
                        updatePronunciationMethod();
                        break;
                }
            }
        });

        // æ–‡æœ¬è¾“å…¥æ¡†å›è½¦é”®æ”¯æŒ
        document.getElementById('testText').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                testEnhancedPronunciation();
            }
        });
    </script>
</body>
</html>
