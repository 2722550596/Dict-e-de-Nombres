<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Test de Voix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .back-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            background: #5a6268;
        }

        .language-selectors {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .language-selector {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .language-selector label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin: 0;
        }

        .language-selector select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
        }

        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        .button:hover {
            background: #0056b3;
        }

        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .button.danger {
            background: #dc3545;
        }

        .button.danger:hover {
            background: #c82333;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            color: #856404;
            display: none;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            color: #0c5460;
            display: none;
        }

        .voice-list {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .voice-list ul {
            margin: 0;
            padding-left: 20px;
        }

        .voice-list li {
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }

        .voice-list li.target-language {
            font-weight: bold;
            color: #007bff;
        }

        .voice-selector {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 10px 0;
            width: 100%;
            max-width: 400px;
            font-size: 14px;
        }

        .saved-voice-status {
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .controls-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        @media (max-width: 600px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .language-selectors {
                justify-content: center;
            }

            .controls-section {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-button" onclick="window.close(); window.history.back();">
                ‚Üê <span id="back-text">Retour</span>
            </button>
            <h1 id="main-title" style="margin: 0;">Test de Voix</h1>
            <div class="language-selectors">
                <div class="language-selector">
                    <label id="interface-lang-label">Langue de l'interface</label>
                    <select id="interfaceLanguageSelect">
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="en">üá∫üá∏ English</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                    </select>
                </div>
                <div class="language-selector">
                    <label id="test-lang-label">Langue de test</label>
                    <select id="testLanguageSelect">
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
            </div>
        </div>

        <div id="warning" class="warning"></div>
        <div id="info" class="info"></div>

        <div id="savedVoiceStatus" class="saved-voice-status">
            <strong id="saved-voice-label">Voix sauvegard√©e actuelle:</strong>
            <span id="savedVoiceInfo"></span>
        </div>
    </div>

    <div class="container">
        <div>
            <label for="voiceSelect" id="select-voice-label">S√©lectionner une voix:</label>
            <select id="voiceSelect" class="voice-selector" onchange="onVoiceChange()">
                <option value="" id="default-voice-option">Voix par d√©faut</option>
            </select>
        </div>

        <div class="controls-section">
            <button class="button" id="testVoiceBtn" onclick="testSelectedVoice()">Tester la voix s√©lectionn√©e</button>
            <button class="button" id="testAllVoicesBtn" onclick="testAllTargetVoices()">Tester toutes les voix disponibles</button>
            <button class="button" id="listVoicesBtn" onclick="listVoices()">Lister toutes les voix</button>
            <button class="button danger" id="clearSavedVoiceBtn" onclick="clearSavedVoice()">Effacer la voix sauvegard√©e</button>
        </div>

        <div id="voiceList" class="voice-list"></div>
    </div>

    <script>
        // ÊîØÊåÅÁöÑÂê¨ÂÜôËØ≠Ë®ÄÔºà‰ªéÈ°πÁõÆÈÖçÁΩÆÂ§çÂà∂Ôºâ
        const DICTATION_LANGUAGES = [
            { code: 'fr', name: 'Fran√ßais', flag: 'üá´üá∑', speechLang: 'fr-FR' },
            { code: 'en', name: 'English', flag: 'üá∫üá∏', speechLang: 'en-US' },
            { code: 'de', name: 'Deutsch', flag: 'üá©üá™', speechLang: 'de-DE' },
            { code: 'es', name: 'Espa√±ol', flag: 'üá™üá∏', speechLang: 'es-ES' },
            { code: 'it', name: 'Italiano', flag: 'üáÆüáπ', speechLang: 'it-IT' },
            { code: 'pt', name: 'Portugu√™s', flag: 'üáµüáπ', speechLang: 'pt-PT' },
            { code: 'zh', name: '‰∏≠Êñá', flag: 'üá®üá≥', speechLang: 'zh-CN' },
            { code: 'ja', name: 'Êó•Êú¨Ë™û', flag: 'üáØüáµ', speechLang: 'ja-JP' },
            { code: 'ko', name: 'ÌïúÍµ≠Ïñ¥', flag: 'üá∞üá∑', speechLang: 'ko-KR' },
            { code: 'ar', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', flag: 'üá∏üá¶', speechLang: 'ar-SA' },
            { code: 'ru', name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫', speechLang: 'ru-RU' },
            { code: 'nl', name: 'Nederlands', flag: 'üá≥üá±', speechLang: 'nl-NL' },
            { code: 'sv', name: 'Svenska', flag: 'üá∏üá™', speechLang: 'sv-SE' },
            { code: 'da', name: 'Dansk', flag: 'üá©üá∞', speechLang: 'da-DK' }
        ];

        // ÂÖ®Â±ÄÂèòÈáè
        let selectedVoice = null;
        let currentInterfaceLanguage = 'fr';
        let currentTestLanguage = 'fr';
        let translations = {};

        // ÁøªËØëÊï∞ÊçÆÔºàÁÆÄÂåñÁâàÊú¨Ôºå‰ªéÈ°πÁõÆÁøªËØëÊñá‰ª∂ÊèêÂèñÔºâ
        const TRANSLATIONS = {
            fr: {
                title: "Test de Voix",
                backText: "Retour",
                interfaceLanguage: "Langue de l'interface",
                testLanguage: "Langue de test",
                selectTestLanguage: "S√©lectionner la langue de test",
                browserNotSupported: "Votre navigateur ne supporte pas Web Speech API",
                noTargetVoiceDetected: "Aucune voix d√©tect√©e pour la langue s√©lectionn√©e. Sur iOS, allez dans R√©glages > Accessibilit√© > Contenu √©nonc√© > Voix pour ajouter des voix.",
                voiceListUpdated: "Liste des voix mise √† jour",
                noTargetVoiceAvailable: "Aucune voix disponible pour la langue s√©lectionn√©e",
                noVoiceFound: "Aucune voix trouv√©e, veuillez r√©essayer plus tard",
                speechSynthesisNotSupported: "Votre navigateur ne supporte pas la synth√®se vocale",
                noTargetVoiceFoundUsingDefault: "Aucune voix trouv√©e pour la langue s√©lectionn√©e, utilisation de la voix par d√©faut",
                speechError: "Erreur vocale",
                readingStarted: "Lecture commenc√©e",
                readingFinished: "Lecture termin√©e",
                testingAllTargetVoices: "Test de toutes les voix disponibles...",
                availableVoices: "Voix disponibles:",
                voicesDetected: "voix d√©tect√©e(s)",
                currentSavedVoice: "Voix sauvegard√©e actuelle:",
                selectVoice: "S√©lectionner une voix:",
                testSelectedVoice: "Tester la voix s√©lectionn√©e",
                testAllVoices: "Tester toutes les voix disponibles",
                listAllVoices: "Lister toutes les voix",
                clearSavedVoice: "Effacer la voix sauvegard√©e",
                usingVoice: "Utilisation de la voix",
                testCompleted: "Test termin√©",
                voiceRestored: "Voix restaur√©e",
                voiceSavedNotAvailable: "La voix sauvegard√©e n'est plus disponible",
                voiceSelectedAndSaved: "Voix s√©lectionn√©e et sauvegard√©e",
                usingDefaultVoice: "Utilisation de la voix par d√©faut",
                voiceSavedCleared: "Voix sauvegard√©e effac√©e. Utilisation de la voix par d√©faut.",
                testSample: "1, 2, 3, 4, 5",
                defaultVoiceOption: "Voix par d√©faut"
            },
            en: {
                title: "Voice Test",
                backText: "Back",
                interfaceLanguage: "Interface Language",
                testLanguage: "Test Language",
                selectTestLanguage: "Select test language",
                browserNotSupported: "Your browser does not support Web Speech API",
                noTargetVoiceDetected: "No voice detected for the selected language. On iOS, go to Settings > Accessibility > Spoken Content > Voices to add voices.",
                voiceListUpdated: "Voice list updated",
                noTargetVoiceAvailable: "No voice available for the selected language",
                noVoiceFound: "No voices found, please try again later",
                speechSynthesisNotSupported: "Your browser does not support speech synthesis",
                noTargetVoiceFoundUsingDefault: "No voice found for the selected language, using default voice",
                speechError: "Speech error",
                readingStarted: "Reading started",
                readingFinished: "Reading finished",
                testingAllTargetVoices: "Testing all available voices...",
                availableVoices: "Available voices:",
                voicesDetected: "voice(s) detected",
                currentSavedVoice: "Current saved voice:",
                selectVoice: "Select a voice:",
                testSelectedVoice: "Test selected voice",
                testAllVoices: "Test all available voices",
                listAllVoices: "List all voices",
                clearSavedVoice: "Clear saved voice",
                usingVoice: "Using voice",
                testCompleted: "Test completed",
                voiceRestored: "Voice restored",
                voiceSavedNotAvailable: "The saved voice is no longer available",
                voiceSelectedAndSaved: "Voice selected and saved",
                usingDefaultVoice: "Using default voice",
                voiceSavedCleared: "Saved voice cleared. Using default voice.",
                testSample: "1, 2, 3, 4, 5",
                defaultVoiceOption: "Default voice"
            },
            zh: {
                title: "ËØ≠Èü≥ÊµãËØï",
                backText: "ËøîÂõû",
                interfaceLanguage: "ÁïåÈù¢ËØ≠Ë®Ä",
                testLanguage: "ÊµãËØïËØ≠Ë®Ä",
                selectTestLanguage: "ÈÄâÊã©ÊµãËØïËØ≠Ë®Ä",
                browserNotSupported: "ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅWeb Speech API",
                noTargetVoiceDetected: "Êú™Ê£ÄÊµãÂà∞ÊâÄÈÄâËØ≠Ë®ÄÁöÑËØ≠Èü≥„ÄÇÂú®iOS‰∏äÔºåËØ∑ÂâçÂæÄËÆæÁΩÆ > ËæÖÂä©ÂäüËÉΩ > ÊúóËØªÂÜÖÂÆπ > ËØ≠Èü≥Êù•Ê∑ªÂä†ËØ≠Èü≥„ÄÇ",
                voiceListUpdated: "ËØ≠Èü≥ÂàóË°®Â∑≤Êõ¥Êñ∞",
                noTargetVoiceAvailable: "ÊâÄÈÄâËØ≠Ë®ÄÊ≤°ÊúâÂèØÁî®ÁöÑËØ≠Èü≥",
                noVoiceFound: "Êú™ÊâæÂà∞ËØ≠Èü≥ÔºåËØ∑Á®çÂêéÈáçËØï",
                speechSynthesisNotSupported: "ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÂêàÊàê",
                noTargetVoiceFoundUsingDefault: "Êú™ÊâæÂà∞ÊâÄÈÄâËØ≠Ë®ÄÁöÑËØ≠Èü≥Ôºå‰ΩøÁî®ÈªòËÆ§ËØ≠Èü≥",
                speechError: "ËØ≠Èü≥ÈîôËØØ",
                readingStarted: "ÂºÄÂßãÊúóËØª",
                readingFinished: "ÊúóËØªÂÆåÊàê",
                testingAllTargetVoices: "ÊµãËØïÊâÄÊúâÂèØÁî®ËØ≠Èü≥...",
                availableVoices: "ÂèØÁî®ËØ≠Èü≥Ôºö",
                voicesDetected: "Ê£ÄÊµãÂà∞ËØ≠Èü≥",
                currentSavedVoice: "ÂΩìÂâç‰øùÂ≠òÁöÑËØ≠Èü≥Ôºö",
                selectVoice: "ÈÄâÊã©ËØ≠Èü≥Ôºö",
                testSelectedVoice: "ÊµãËØïÈÄâ‰∏≠ÁöÑËØ≠Èü≥",
                testAllVoices: "ÊµãËØïÊâÄÊúâÂèØÁî®ËØ≠Èü≥",
                listAllVoices: "ÂàóÂá∫ÊâÄÊúâËØ≠Èü≥",
                clearSavedVoice: "Ê∏ÖÈô§‰øùÂ≠òÁöÑËØ≠Èü≥",
                usingVoice: "‰ΩøÁî®ËØ≠Èü≥",
                testCompleted: "ÊµãËØïÂÆåÊàê",
                voiceRestored: "ËØ≠Èü≥Â∑≤ÊÅ¢Â§ç",
                voiceSavedNotAvailable: "‰øùÂ≠òÁöÑËØ≠Èü≥‰∏çÂÜçÂèØÁî®",
                voiceSelectedAndSaved: "ËØ≠Èü≥Â∑≤ÈÄâÊã©Âπ∂‰øùÂ≠ò",
                usingDefaultVoice: "‰ΩøÁî®ÈªòËÆ§ËØ≠Èü≥",
                voiceSavedCleared: "Â∑≤Ê∏ÖÈô§‰øùÂ≠òÁöÑËØ≠Èü≥„ÄÇ‰ΩøÁî®ÈªòËÆ§ËØ≠Èü≥„ÄÇ",
                testSample: "1, 2, 3, 4, 5",
                defaultVoiceOption: "ÈªòËÆ§ËØ≠Èü≥"
            }
        };

        // ÂàùÂßãÂåñÁøªËØë
        translations = TRANSLATIONS.fr;

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function showWarning(message) {
            const warning = document.getElementById('warning');
            warning.textContent = message;
            warning.style.display = 'block';
        }

        function showInfo(message) {
            const info = document.getElementById('info');
            info.textContent = message;
            info.style.display = 'block';
        }

        function clearMessages() {
            document.getElementById('warning').style.display = 'none';
            document.getElementById('info').style.display = 'none';
        }

        // Ëé∑ÂèñÂΩìÂâçÊµãËØïËØ≠Ë®ÄÈÖçÁΩÆ
        function getCurrentTestLanguage() {
            return DICTATION_LANGUAGES.find(lang => lang.code === currentTestLanguage) || DICTATION_LANGUAGES[0];
        }

        // Ëé∑ÂèñÂΩìÂâçÊµãËØïËØ≠Ë®ÄÁöÑÊâÄÊúâËØ≠Èü≥
        function getTargetLanguageVoices() {
            if (!window.speechSynthesis) return [];

            const voices = window.speechSynthesis.getVoices();
            const targetLang = getCurrentTestLanguage();

            return voices.filter(voice => {
                // Á≤æÁ°ÆÂåπÈÖçËØ≠Ë®Ä‰ª£Á†Å
                if (voice.lang.toLowerCase() === targetLang.speechLang.toLowerCase()) {
                    return true;
                }
                // ÂåπÈÖçËØ≠Ë®ÄÂâçÁºÄÔºàÂ¶Ç fr ÂåπÈÖç fr-FR, fr-CA Á≠âÔºâ
                const voiceLangPrefix = voice.lang.split('-')[0].toLowerCase();
                const targetLangPrefix = targetLang.speechLang.split('-')[0].toLowerCase();
                return voiceLangPrefix === targetLangPrefix;
            });
        }

        // Ëé∑ÂèñÊúÄ‰Ω≥ËØ≠Èü≥
        function getBestVoice() {
            if (selectedVoice) {
                return selectedVoice;
            }

            const targetVoices = getTargetLanguageVoices();
            return targetVoices.length > 0 ? targetVoices[0] : null;
        }

        // Â°´ÂÖÖÊµãËØïËØ≠Ë®ÄÈÄâÊã©Âô®
        function populateTestLanguageSelector() {
            console.log('Populating test language selector...');
            const select = document.getElementById('testLanguageSelect');
            if (!select) {
                console.error('testLanguageSelect element not found');
                return;
            }

            select.innerHTML = '';

            DICTATION_LANGUAGES.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.code;
                option.textContent = `${lang.flag} ${lang.name}`;
                select.appendChild(option);
            });

            select.value = currentTestLanguage;
            console.log('Test language selector populated with', DICTATION_LANGUAGES.length, 'languages');
        }

        // Â°´ÂÖÖËØ≠Èü≥ÈÄâÊã©Âô®
        function populateVoiceSelector() {
            const select = document.getElementById('voiceSelect');
            const targetVoices = getTargetLanguageVoices();
            const t = translations;

            select.innerHTML = `<option value="">${t.defaultVoiceOption || 'Default voice'}</option>`;

            targetVoices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                select.appendChild(option);
            });

            if (targetVoices.length === 0) {
                const option = document.createElement('option');
                option.textContent = t.noTargetVoiceAvailable || 'No voice available for selected language';
                option.disabled = true;
                select.appendChild(option);
            }

            restoreSavedVoice();
        }

        // ÊÅ¢Â§ç‰øùÂ≠òÁöÑËØ≠Èü≥
        function restoreSavedVoice() {
            try {
                const storageKey = `selectedVoice_${currentTestLanguage}`;
                const savedVoiceData = localStorage.getItem(storageKey);
                if (savedVoiceData) {
                    const voiceData = JSON.parse(savedVoiceData);
                    const targetVoices = getTargetLanguageVoices();
                    const select = document.getElementById('voiceSelect');

                    const matchingVoiceIndex = targetVoices.findIndex(voice =>
                        voice.voiceURI === voiceData.voiceURI ||
                        (voice.name === voiceData.name && voice.lang === voiceData.lang)
                    );

                    if (matchingVoiceIndex !== -1) {
                        select.value = matchingVoiceIndex;
                        selectedVoice = targetVoices[matchingVoiceIndex];
                        showInfo(`${translations.voiceRestored}: ${selectedVoice.name} (${selectedVoice.lang})`);
                        updateSavedVoiceStatus();
                    } else {
                        localStorage.removeItem(storageKey);
                        showWarning(translations.voiceSavedNotAvailable);
                        updateSavedVoiceStatus();
                    }
                } else {
                    updateSavedVoiceStatus();
                }
            } catch (error) {
                console.error('Error restoring voice:', error);
                const storageKey = `selectedVoice_${currentTestLanguage}`;
                localStorage.removeItem(storageKey);
                updateSavedVoiceStatus();
            }
        }

        // Êõ¥Êñ∞‰øùÂ≠òÁöÑËØ≠Èü≥Áä∂ÊÄÅÊòæÁ§∫
        function updateSavedVoiceStatus() {
            const statusDiv = document.getElementById('savedVoiceStatus');
            const infoSpan = document.getElementById('savedVoiceInfo');

            try {
                const storageKey = `selectedVoice_${currentTestLanguage}`;
                const savedVoiceData = localStorage.getItem(storageKey);
                if (savedVoiceData) {
                    const voiceData = JSON.parse(savedVoiceData);
                    infoSpan.textContent = `${voiceData.name} (${voiceData.lang})`;
                    statusDiv.style.display = 'block';
                } else {
                    statusDiv.style.display = 'none';
                }
            } catch (error) {
                statusDiv.style.display = 'none';
            }
        }

        // Ê∏ÖÈô§‰øùÂ≠òÁöÑËØ≠Èü≥
        function clearSavedVoice() {
            const storageKey = `selectedVoice_${currentTestLanguage}`;
            localStorage.removeItem(storageKey);
            selectedVoice = null;
            const select = document.getElementById('voiceSelect');
            select.value = '';
            updateSavedVoiceStatus();
            showInfo(translations.voiceSavedCleared);
        }

        // ËØ≠Èü≥ÈÄâÊã©ÂèòÂåñÂ§ÑÁêÜ
        function onVoiceChange() {
            clearMessages();
            const select = document.getElementById('voiceSelect');
            const targetVoices = getTargetLanguageVoices();

            if (select.value === '') {
                selectedVoice = null;
                const storageKey = `selectedVoice_${currentTestLanguage}`;
                localStorage.removeItem(storageKey);
                showInfo(translations.usingDefaultVoice);
            } else {
                const voiceIndex = parseInt(select.value);
                selectedVoice = targetVoices[voiceIndex];

                const voiceData = {
                    name: selectedVoice.name,
                    lang: selectedVoice.lang,
                    voiceURI: selectedVoice.voiceURI
                };
                const storageKey = `selectedVoice_${currentTestLanguage}`;
                localStorage.setItem(storageKey, JSON.stringify(voiceData));

                showInfo(`${translations.voiceSelectedAndSaved}: ${selectedVoice.name} (${selectedVoice.lang})`);
            }

            updateSavedVoiceStatus();
        }

        // ÊµãËØïÈÄâ‰∏≠ÁöÑËØ≠Èü≥
        function testSelectedVoice() {
            if (!window.speechSynthesis) {
                showWarning(translations.speechSynthesisNotSupported);
                return;
            }

            clearMessages();

            const testLang = getCurrentTestLanguage();
            const utterance = new SpeechSynthesisUtterance(translations.testSample);
            utterance.lang = testLang.speechLang;

            const bestVoice = getBestVoice();
            if (bestVoice) {
                utterance.voice = bestVoice;
                showInfo(`${translations.usingVoice}: ${bestVoice.name} (${bestVoice.lang})`);
            } else {
                showWarning(translations.noTargetVoiceFoundUsingDefault);
            }

            utterance.onerror = (event) => {
                showWarning(`${translations.speechError}: ${event.error}`);
            };

            utterance.onstart = () => {
                console.log(translations.readingStarted);
            };

            utterance.onend = () => {
                console.log(translations.readingFinished);
            };

            window.speechSynthesis.speak(utterance);
        }

        // ÊµãËØïÊâÄÊúâÁõÆÊ†áËØ≠Ë®ÄÁöÑËØ≠Èü≥
        function testAllTargetVoices() {
            const targetVoices = getTargetLanguageVoices();
            if (targetVoices.length === 0) {
                showWarning(translations.noTargetVoiceAvailable);
                return;
            }

            clearMessages();
            showInfo(translations.testingAllTargetVoices);

            let voiceIndex = 0;
            const testLang = getCurrentTestLanguage();

            function testNextVoice() {
                if (voiceIndex >= targetVoices.length) {
                    showInfo(translations.testCompleted);
                    return;
                }

                const voice = targetVoices[voiceIndex];
                const utterance = new SpeechSynthesisUtterance(`${voiceIndex + 1}: ${voice.name}. ${translations.testSample}`);
                utterance.lang = testLang.speechLang;
                utterance.voice = voice;

                utterance.onstart = () => {
                    showInfo(`${voiceIndex + 1}/${targetVoices.length}: ${voice.name}`);
                };

                utterance.onend = () => {
                    voiceIndex++;
                    setTimeout(testNextVoice, 1000);
                };

                utterance.onerror = () => {
                    voiceIndex++;
                    setTimeout(testNextVoice, 500);
                };

                window.speechSynthesis.speak(utterance);
            }

            testNextVoice();
        }

        // ÂàóÂá∫ÊâÄÊúâËØ≠Èü≥
        function listVoices() {
            const voiceList = document.getElementById('voiceList');
            const voices = window.speechSynthesis.getVoices();

            if (voices.length === 0) {
                voiceList.innerHTML = `<p>${translations.noVoiceFound}</p>`;
                voiceList.style.display = 'block';
                return;
            }

            const testLang = getCurrentTestLanguage();
            let html = `<h3>${translations.availableVoices}</h3><ul>`;
            voices.forEach(voice => {
                const isTargetLanguage = voice.lang.toLowerCase().startsWith(testLang.speechLang.split('-')[0].toLowerCase());
                const className = isTargetLanguage ? 'target-language' : '';
                html += `<li class="${className}">${voice.name} (${voice.lang}) ${voice.default ? '[default]' : ''}</li>`;
            });
            html += '</ul>';

            voiceList.innerHTML = html;
            voiceList.style.display = 'block';
        }

        // Êõ¥Êñ∞È°µÈù¢ÊñáÊú¨
        function updatePageTexts() {
            console.log('Updating page texts with language:', currentInterfaceLanguage);
            const t = translations;

            // ÂÆâÂÖ®Âú∞Êõ¥Êñ∞ÂÖÉÁ¥†ÊñáÊú¨
            const updateElement = (id, text) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = text;
                } else {
                    console.warn(`Element with id '${id}' not found`);
                }
            };

            // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢òÂíåÂÖÉÁ¥†ÊñáÊú¨
            updateElement('page-title', t.title || 'Voice Test');
            updateElement('main-title', t.title || 'Voice Test');
            updateElement('back-text', t.backText || 'Back');
            updateElement('interface-lang-label', t.interfaceLanguage || 'Interface Language');
            updateElement('test-lang-label', t.testLanguage || 'Test Language');
            updateElement('saved-voice-label', t.currentSavedVoice || 'Current saved voice:');
            updateElement('select-voice-label', t.selectVoice || 'Select a voice:');
            updateElement('default-voice-option', t.defaultVoiceOption || 'Default voice');

            // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
            updateElement('testVoiceBtn', t.testSelectedVoice || 'Test selected voice');
            updateElement('testAllVoicesBtn', t.testAllVoices || 'Test all available voices');
            updateElement('listVoicesBtn', t.listAllVoices || 'List all voices');
            updateElement('clearSavedVoiceBtn', t.clearSavedVoice || 'Clear saved voice');

            // Êõ¥Êñ∞HTML langÂ±ûÊÄß
            document.documentElement.lang = currentInterfaceLanguage;
        }

        // ÁïåÈù¢ËØ≠Ë®ÄÂàáÊç¢
        function changeInterfaceLanguage(langCode) {
            console.log('Changing interface language to:', langCode);
            currentInterfaceLanguage = langCode;
            translations = TRANSLATIONS[langCode] || TRANSLATIONS.fr;

            // Êõ¥Êñ∞ÁïåÈù¢ËØ≠Ë®ÄÈÄâÊã©Âô®ÁöÑÂÄº
            const interfaceSelect = document.getElementById('interfaceLanguageSelect');
            if (interfaceSelect && interfaceSelect.value !== langCode) {
                interfaceSelect.value = langCode;
            }

            // Êõ¥Êñ∞È°µÈù¢ÊñáÊú¨
            updatePageTexts();

            // ÂêåÊ≠•Âà∞‰∏ªÈ°µÈù¢Ôºà‰øùÂ≠òÂà∞localStorageÔºå‰∏ªÈ°µÈù¢‰ºöËá™Âä®Ê£ÄÊµãÔºâ
            localStorage.setItem('selectedLanguage', langCode);

            console.log('Interface language changed and synced to main page');
        }

        // ÊµãËØïËØ≠Ë®ÄÂàáÊç¢
        function changeTestLanguage(langCode) {
            console.log('Changing test language to:', langCode);
            currentTestLanguage = langCode;
            selectedVoice = null; // ÈáçÁΩÆÈÄâ‰∏≠ÁöÑËØ≠Èü≥
            localStorage.setItem('selectedDictationLanguage', langCode);

            // Ê∏ÖÈô§Ê∂àÊÅØ
            clearMessages();

            // ÈáçÊñ∞Â°´ÂÖÖËØ≠Èü≥ÈÄâÊã©Âô®
            populateVoiceSelector();

            // Êõ¥Êñ∞ËØ≠Èü≥Áä∂ÊÄÅÊòæÁ§∫
            updateSavedVoiceStatus();

            // ÈöêËóèËØ≠Èü≥ÂàóË°®
            const voiceList = document.getElementById('voiceList');
            if (voiceList) {
                voiceList.style.display = 'none';
            }

            // ÊòæÁ§∫Ê£ÄÊµãÂà∞ÁöÑËØ≠Èü≥Êï∞Èáè
            const targetVoices = getTargetLanguageVoices();
            const testLang = getCurrentTestLanguage();
            if (targetVoices.length === 0) {
                showWarning(translations.noTargetVoiceDetected || 'No voice detected for the selected language');
            } else {
                showInfo(`${testLang.name}: ${targetVoices.length} ${translations.voicesDetected || 'voice(s) detected'}`);
            }
        }

        // ÂàùÂßãÂåñÂáΩÊï∞
        function initialize() {
            console.log('Initializing voice test page...');

            // Ëá™Âä®Ë∑üÈöè‰∏ªÈ°µÈù¢ÁöÑÁïåÈù¢ËØ≠Ë®ÄËÆæÁΩÆ
            const savedInterfaceLanguage = localStorage.getItem('selectedLanguage');
            if (savedInterfaceLanguage && TRANSLATIONS[savedInterfaceLanguage]) {
                currentInterfaceLanguage = savedInterfaceLanguage;
                console.log('Following main page interface language:', savedInterfaceLanguage);
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑËØ≠Ë®ÄÔºåÊ£ÄÊµãÊµèËßàÂô®ËØ≠Ë®Ä
                const browserLang = navigator.language.split('-')[0];
                if (TRANSLATIONS[browserLang]) {
                    currentInterfaceLanguage = browserLang;
                    console.log('Using browser language:', browserLang);
                } else {
                    currentInterfaceLanguage = 'fr'; // ÈªòËÆ§Ê≥ïËØ≠
                    console.log('Using default language: fr');
                }
            }

            // ÊÅ¢Â§ç‰øùÂ≠òÁöÑÊµãËØïËØ≠Ë®Ä
            const savedTestLanguage = localStorage.getItem('selectedDictationLanguage');
            if (savedTestLanguage && DICTATION_LANGUAGES.find(lang => lang.code === savedTestLanguage)) {
                currentTestLanguage = savedTestLanguage;
                console.log('Restored test language:', savedTestLanguage);
            } else {
                // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÊµãËØïËØ≠Ë®ÄÔºå‰ΩøÁî®ÁïåÈù¢ËØ≠Ë®Ä‰Ωú‰∏∫ÈªòËÆ§ÊµãËØïËØ≠Ë®ÄÔºàÂ¶ÇÊûúÊîØÊåÅÁöÑËØùÔºâ
                const matchingTestLang = DICTATION_LANGUAGES.find(lang => lang.code === currentInterfaceLanguage);
                if (matchingTestLang) {
                    currentTestLanguage = currentInterfaceLanguage;
                    console.log('Using interface language as test language:', currentInterfaceLanguage);
                } else {
                    currentTestLanguage = 'fr'; // ÈªòËÆ§Ê≥ïËØ≠
                    console.log('Using default test language: fr');
                }
            }

            // ËÆæÁΩÆÁøªËØë
            translations = TRANSLATIONS[currentInterfaceLanguage] || TRANSLATIONS.fr;

            // ËÆæÁΩÆÁïåÈù¢ËØ≠Ë®ÄÈÄâÊã©Âô®ÁöÑÂÄºÔºàË∑üÈöè‰∏ªÈ°µÈù¢Ôºâ
            const interfaceSelect = document.getElementById('interfaceLanguageSelect');
            if (interfaceSelect) {
                interfaceSelect.value = currentInterfaceLanguage;
            }

            // Â°´ÂÖÖÊµãËØïËØ≠Ë®ÄÈÄâÊã©Âô®
            populateTestLanguageSelector();

            // Êõ¥Êñ∞È°µÈù¢ÊñáÊú¨
            updatePageTexts();

            // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
            const interfaceLanguageSelect = document.getElementById('interfaceLanguageSelect');
            const testLanguageSelect = document.getElementById('testLanguageSelect');

            if (interfaceLanguageSelect) {
                interfaceLanguageSelect.addEventListener('change', (e) => {
                    changeInterfaceLanguage(e.target.value);
                });
            }

            if (testLanguageSelect) {
                testLanguageSelect.addEventListener('change', (e) => {
                    changeTestLanguage(e.target.value);
                });
            }

            // ÁõëÂê¨‰∏ªÈ°µÈù¢ËØ≠Ë®ÄÂèòÂåñÔºàÂ¶ÇÊûúÂú®Âêå‰∏Ä‰∏™Á™óÂè£‰∏≠Ôºâ
            window.addEventListener('storage', (e) => {
                if (e.key === 'selectedLanguage' && e.newValue && TRANSLATIONS[e.newValue]) {
                    console.log('Main page language changed to:', e.newValue);
                    changeInterfaceLanguage(e.newValue);
                }
            });

            console.log('Initialization complete - Interface:', currentInterfaceLanguage, 'Test:', currentTestLanguage);
        }

        // Ê£ÄÊü•ËØ≠Èü≥ÂèØÁî®ÊÄß
        function checkVoices() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                setTimeout(checkVoices, 100);
                return;
            }

            populateVoiceSelector();

            // Âè™Âú®ÂàùÂßãÂåñÊó∂ÊòæÁ§∫ËØ≠Èü≥Ê£ÄÊµã‰ø°ÊÅØ
            if (!window.voicesInitialized) {
                const targetVoices = getTargetLanguageVoices();
                const testLang = getCurrentTestLanguage();
                if (targetVoices.length === 0) {
                    showWarning(translations.noTargetVoiceDetected);
                } else {
                    showInfo(`${testLang.name}: ${targetVoices.length} ${translations.voicesDetected}`);
                }
                window.voicesInitialized = true;
            }
        }

        // È°µÈù¢Âä†ËΩΩ‰∫ã‰ª∂
        window.addEventListener('load', () => {
            console.log('Page loaded, starting initialization...');

            if (!window.speechSynthesis) {
                showWarning('Your browser does not support Web Speech API');
                return;
            }

            // ÂÖàÂàùÂßãÂåñÈ°µÈù¢
            initialize();

            // ÁÑ∂ÂêéÊ£ÄÊü•ËØ≠Èü≥
            checkVoices();
        });

        // ËØ≠Èü≥ÂàóË°®ÂèòÂåñ‰∫ã‰ª∂
        window.speechSynthesis.onvoiceschanged = () => {
            console.log('Voice list changed');
            if (window.voicesInitialized) {
                populateVoiceSelector();
            }
        };
    </script>
</body>
</html>
