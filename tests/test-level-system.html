<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°ç­‰çº§ç³»ç»Ÿæµ‹è¯•éªŒè¯</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
        }
        
        .test-section h2 {
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .test-result.pass {
            background: #c6f6d5;
            border-left: 4px solid #38a169;
        }
        
        .test-result.fail {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
        }
        
        .test-result.info {
            background: #bee3f8;
            border-left: 4px solid #3182ce;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }
        
        .comparison-table th {
            background: #edf2f7;
            font-weight: bold;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f7fafc;
        }
        
        .phase-1 { color: #38a169; font-weight: bold; }
        .phase-2 { color: #3182ce; font-weight: bold; }
        .phase-3 { color: #e53e3e; font-weight: bold; }
        
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #3182ce;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ–°ç­‰çº§ç³»ç»Ÿæµ‹è¯•éªŒè¯</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š ç­‰çº§æ›²çº¿å¯¹æ¯”åˆ†æ</h2>
            <button onclick="runComparisonTest()">è¿è¡Œå¯¹æ¯”æµ‹è¯•</button>
            <div id="comparison-results"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ” æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="runCoreTests()">è¿è¡Œæ ¸å¿ƒæµ‹è¯•</button>
            <div id="core-test-results"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ† é‡Œç¨‹ç¢‘ç³»ç»Ÿæµ‹è¯•</h2>
            <button onclick="runMilestoneTests()">è¿è¡Œé‡Œç¨‹ç¢‘æµ‹è¯•</button>
            <div id="milestone-results"></div>
        </div>
        
        <div class="test-section">
            <h2>âš¡ æ€§èƒ½æµ‹è¯•</h2>
            <button onclick="runPerformanceTests()">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
            <div id="performance-results"></div>
        </div>
    </div>

    <script>
        // æ–°ç­‰çº§ç³»ç»Ÿå®ç°
        class NewLevelSystem {
            static experienceCache = new Map();
            static maxLevel = 100;
            
            static getExperienceRequiredForLevel(level) {
                const safeLevel = Math.max(1, Math.min(level, this.maxLevel));
                
                if (safeLevel <= 1) return 0;
                
                if (this.experienceCache.has(safeLevel)) {
                    return this.experienceCache.get(safeLevel);
                }
                
                let totalExp = 0;
                
                // ç¬¬ä¸€é˜¶æ®µ (2-10çº§): å¿«é€Ÿå‡çº§æœŸ
                for (let i = 2; i <= Math.min(safeLevel, 10); i++) {
                    const expForLevel = Math.floor(100 * Math.pow(1.4, i - 2));
                    totalExp += expForLevel;
                }
                
                // ç¬¬äºŒé˜¶æ®µ (11-30çº§): ç¨³å®šå¢é•¿æœŸ
                if (safeLevel > 10) {
                    for (let i = 11; i <= Math.min(safeLevel, 30); i++) {
                        const additionalLevel = i - 10;
                        const expForLevel = Math.floor(500 * Math.pow(1.3, additionalLevel - 1));
                        totalExp += expForLevel;
                    }
                }
                
                // ç¬¬ä¸‰é˜¶æ®µ (31çº§+): æŒ‘æˆ˜æœŸ
                if (safeLevel > 30) {
                    for (let i = 31; i <= safeLevel; i++) {
                        const additionalLevel = i - 30;
                        const expForLevel = Math.floor(2000 * Math.pow(1.25, additionalLevel - 1));
                        totalExp += expForLevel;
                    }
                }
                
                this.experienceCache.set(safeLevel, totalExp);
                return totalExp;
            }
            
            static getExperienceForNextLevel(level) {
                const safeLevel = Math.max(1, Math.min(level, this.maxLevel));
                
                if (safeLevel >= this.maxLevel) return 0;
                
                const currentLevelExp = this.getExperienceRequiredForLevel(safeLevel);
                const nextLevelExp = this.getExperienceRequiredForLevel(safeLevel + 1);
                
                return nextLevelExp - currentLevelExp;
            }
            
            static calculateLevel(experience) {
                const safeExperience = Math.max(0, experience);
                
                if (safeExperience === 0) return 1;
                
                // äºŒåˆ†æŸ¥æ‰¾ä¼˜åŒ–
                let left = 1;
                let right = this.maxLevel;
                let result = 1;
                
                while (left <= right) {
                    const mid = Math.floor((left + right) / 2);
                    const requiredExp = this.getExperienceRequiredForLevel(mid);
                    
                    if (requiredExp <= safeExperience) {
                        result = mid;
                        left = mid + 1;
                    } else {
                        right = mid - 1;
                    }
                }
                
                return result;
            }
            
            static getExperienceProgress(experience) {
                const safeExperience = Math.max(0, experience);
                const level = this.calculateLevel(safeExperience);
                
                const currentLevelRequiredExp = this.getExperienceRequiredForLevel(level);
                const nextLevelRequiredExp = this.getExperienceRequiredForLevel(level + 1);
                
                const currentLevelExp = Math.max(0, safeExperience - currentLevelRequiredExp);
                const nextLevelExp = nextLevelRequiredExp - currentLevelRequiredExp;
                
                let progress = 0;
                if (nextLevelExp > 0) {
                    progress = currentLevelExp / nextLevelExp;
                } else {
                    progress = 1;
                }
                
                return {
                    level,
                    currentLevelExp: Math.max(0, currentLevelExp),
                    nextLevelExp: Math.max(0, nextLevelExp),
                    progress: Math.min(1, Math.max(0, progress))
                };
            }
            
            static clearCache() {
                this.experienceCache.clear();
            }
        }
        
        // æ—§ç­‰çº§ç³»ç»Ÿï¼ˆç”¨äºå¯¹æ¯”ï¼‰
        class OldLevelSystem {
            static calculateLevel(experience) {
                const safeExperience = Math.max(0, experience);
                
                let currentExp = 0;
                let level = 1;
                let expForNextLevel = 150;
                
                while (currentExp + expForNextLevel <= safeExperience) {
                    currentExp += expForNextLevel;
                    level++;
                    expForNextLevel = 150 + (level - 2) * 50;
                    
                    if (level > 100) break;
                }
                
                return level;
            }
            
            static getExperienceRequiredForLevel(level) {
                const safeLevel = Math.max(1, level);
                
                if (safeLevel <= 1) return 0;
                
                let totalExp = 0;
                for (let i = 2; i <= safeLevel; i++) {
                    totalExp += 150 + (i - 2) * 50;
                    if (i > 100) break;
                }
                
                return totalExp;
            }
        }
        
        // é‡Œç¨‹ç¢‘å®šä¹‰
        const LEVEL_MILESTONES = [
            { level: 5, title: "åˆå­¦è€…", description: "å®ŒæˆåŸºç¡€ç»ƒä¹ " },
            { level: 10, title: "ç»ƒä¹ è€…", description: "å»ºç«‹å­¦ä¹ ä¹ æƒ¯" },
            { level: 20, title: "ç†Ÿç»ƒè€…", description: "æŒæ¡æ ¸å¿ƒæŠ€èƒ½" },
            { level: 30, title: "ä¸“å®¶", description: "è¾¾åˆ°é«˜çº§æ°´å¹³" },
            { level: 50, title: "å¤§å¸ˆ", description: "æˆä¸ºæ•°å­—å¬å†™å¤§å¸ˆ" }
        ];
        
        function runComparisonTest() {
            const resultsDiv = document.getElementById('comparison-results');
            resultsDiv.innerHTML = '<h3>ç­‰çº§æ›²çº¿å¯¹æ¯”</h3>';
            
            const comparisonData = [];
            const testLevels = [1, 2, 3, 4, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50];
            
            testLevels.forEach(level => {
                const oldExp = OldLevelSystem.getExperienceRequiredForLevel(level);
                const newExp = NewLevelSystem.getExperienceRequiredForLevel(level);
                const oldNextLevel = level === 1 ? 150 : OldLevelSystem.getExperienceRequiredForLevel(level + 1) - oldExp;
                const newNextLevel = NewLevelSystem.getExperienceForNextLevel(level);
                
                let phase = '';
                let phaseClass = '';
                if (level <= 10) {
                    phase = 'å¿«é€Ÿå‡çº§æœŸ';
                    phaseClass = 'phase-1';
                } else if (level <= 30) {
                    phase = 'ç¨³å®šå¢é•¿æœŸ';
                    phaseClass = 'phase-2';
                } else {
                    phase = 'æŒ‘æˆ˜æœŸ';
                    phaseClass = 'phase-3';
                }
                
                comparisonData.push({
                    level,
                    oldExp,
                    newExp,
                    oldNextLevel,
                    newNextLevel,
                    phase,
                    phaseClass,
                    ratio: newExp / Math.max(oldExp, 1)
                });
            });
            
            let tableHTML = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>ç­‰çº§</th>
                            <th>é˜¶æ®µ</th>
                            <th>æ—§ç³»ç»Ÿæ€»ç»éªŒ</th>
                            <th>æ–°ç³»ç»Ÿæ€»ç»éªŒ</th>
                            <th>æ—§ç³»ç»Ÿå‡çº§éœ€æ±‚</th>
                            <th>æ–°ç³»ç»Ÿå‡çº§éœ€æ±‚</th>
                            <th>éš¾åº¦æ¯”ä¾‹</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            comparisonData.forEach(data => {
                const ratioColor = data.ratio > 2 ? '#e53e3e' : data.ratio > 1.5 ? '#d69e2e' : '#38a169';
                tableHTML += `
                    <tr>
                        <td>${data.level}</td>
                        <td class="${data.phaseClass}">${data.phase}</td>
                        <td>${data.oldExp.toLocaleString()}</td>
                        <td>${data.newExp.toLocaleString()}</td>
                        <td>${data.oldNextLevel.toLocaleString()}</td>
                        <td>${data.newNextLevel.toLocaleString()}</td>
                        <td style="color: ${ratioColor}; font-weight: bold;">${data.ratio.toFixed(2)}x</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            resultsDiv.innerHTML += tableHTML;
            
            // æ·»åŠ åˆ†ææ€»ç»“
            const avgRatio = comparisonData.reduce((sum, data) => sum + data.ratio, 0) / comparisonData.length;
            resultsDiv.innerHTML += `
                <div class="test-result info">
                    <strong>åˆ†ææ€»ç»“ï¼š</strong><br>
                    â€¢ å¹³å‡éš¾åº¦æå‡ï¼š${avgRatio.toFixed(2)}å€<br>
                    â€¢ å‰æœŸï¼ˆ1-10çº§ï¼‰ï¼šç›¸å¯¹å®¹æ˜“ï¼Œä¿æŒç”¨æˆ·å‚ä¸åº¦<br>
                    â€¢ ä¸­æœŸï¼ˆ11-30çº§ï¼‰ï¼šç¨³å®šå¢é•¿ï¼Œå»ºç«‹å­¦ä¹ ä¹ æƒ¯<br>
                    â€¢ åæœŸï¼ˆ31çº§+ï¼‰ï¼šæ˜¾è‘—æŒ‘æˆ˜ï¼Œæä¾›é•¿æœŸç›®æ ‡
                </div>
            `;
        }
        
        function runCoreTests() {
            const resultsDiv = document.getElementById('core-test-results');
            resultsDiv.innerHTML = '<h3>æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ç»“æœ</h3>';
            
            const tests = [
                {
                    name: 'ç­‰çº§1åº”è¯¥éœ€è¦0ç»éªŒ',
                    test: () => NewLevelSystem.getExperienceRequiredForLevel(1) === 0,
                    expected: 0,
                    actual: NewLevelSystem.getExperienceRequiredForLevel(1)
                },
                {
                    name: 'ç­‰çº§2åº”è¯¥éœ€è¦100ç»éªŒ',
                    test: () => NewLevelSystem.getExperienceRequiredForLevel(2) === 100,
                    expected: 100,
                    actual: NewLevelSystem.getExperienceRequiredForLevel(2)
                },
                {
                    name: '100ç»éªŒåº”è¯¥æ˜¯ç­‰çº§2',
                    test: () => NewLevelSystem.calculateLevel(100) === 2,
                    expected: 2,
                    actual: NewLevelSystem.calculateLevel(100)
                },
                {
                    name: '99ç»éªŒåº”è¯¥æ˜¯ç­‰çº§1',
                    test: () => NewLevelSystem.calculateLevel(99) === 1,
                    expected: 1,
                    actual: NewLevelSystem.calculateLevel(99)
                },
                {
                    name: 'è´Ÿæ•°ç»éªŒåº”è¯¥æ˜¯ç­‰çº§1',
                    test: () => NewLevelSystem.calculateLevel(-100) === 1,
                    expected: 1,
                    actual: NewLevelSystem.calculateLevel(-100)
                },
                {
                    name: 'ç­‰çº§è¿›åº¦è®¡ç®—åº”è¯¥æ­£ç¡®',
                    test: () => {
                        const progress = NewLevelSystem.getExperienceProgress(150);
                        return progress.level === 2 && progress.currentLevelExp === 50;
                    },
                    expected: 'level=2, currentLevelExp=50',
                    actual: (() => {
                        const p = NewLevelSystem.getExperienceProgress(150);
                        return `level=${p.level}, currentLevelExp=${p.currentLevelExp}`;
                    })()
                }
            ];
            
            let passCount = 0;
            tests.forEach(test => {
                const passed = test.test();
                if (passed) passCount++;
                
                resultsDiv.innerHTML += `
                    <div class="test-result ${passed ? 'pass' : 'fail'}">
                        ${passed ? 'âœ…' : 'âŒ'} ${test.name}<br>
                        æœŸæœ›: ${test.expected}, å®é™…: ${test.actual}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML += `
                <div class="test-result info">
                    <strong>æµ‹è¯•æ€»ç»“ï¼š</strong> ${passCount}/${tests.length} ä¸ªæµ‹è¯•é€šè¿‡
                </div>
            `;
        }
        
        function runMilestoneTests() {
            const resultsDiv = document.getElementById('milestone-results');
            resultsDiv.innerHTML = '<h3>é‡Œç¨‹ç¢‘ç³»ç»Ÿæµ‹è¯•</h3>';
            
            LEVEL_MILESTONES.forEach(milestone => {
                const requiredExp = NewLevelSystem.getExperienceRequiredForLevel(milestone.level);
                const nextLevelExp = NewLevelSystem.getExperienceForNextLevel(milestone.level);
                
                resultsDiv.innerHTML += `
                    <div class="test-result info">
                        <strong>ç­‰çº§ ${milestone.level} - ${milestone.title}</strong><br>
                        ${milestone.description}<br>
                        éœ€è¦æ€»ç»éªŒ: ${requiredExp.toLocaleString()}<br>
                        å‡çº§éœ€æ±‚: ${nextLevelExp.toLocaleString()}
                    </div>
                `;
            });
        }
        
        function runPerformanceTests() {
            const resultsDiv = document.getElementById('performance-results');
            resultsDiv.innerHTML = '<h3>æ€§èƒ½æµ‹è¯•ç»“æœ</h3>';
            
            // æ¸…ç©ºç¼“å­˜ä»¥æµ‹è¯•åˆå§‹æ€§èƒ½
            NewLevelSystem.clearCache();
            
            // æµ‹è¯•é«˜ç­‰çº§è®¡ç®—æ€§èƒ½
            const start1 = performance.now();
            for (let level = 80; level <= 100; level++) {
                NewLevelSystem.getExperienceRequiredForLevel(level);
            }
            const time1 = performance.now() - start1;
            
            // æµ‹è¯•ç¼“å­˜æ€§èƒ½
            const start2 = performance.now();
            for (let level = 80; level <= 100; level++) {
                NewLevelSystem.getExperienceRequiredForLevel(level);
            }
            const time2 = performance.now() - start2;
            
            // æµ‹è¯•åå‘æŸ¥æ‰¾æ€§èƒ½
            const start3 = performance.now();
            const testExperiences = [1000, 10000, 100000, 500000, 1000000];
            testExperiences.forEach(exp => {
                NewLevelSystem.calculateLevel(exp);
            });
            const time3 = performance.now() - start3;
            
            resultsDiv.innerHTML += `
                <div class="test-result ${time1 < 50 ? 'pass' : 'fail'}">
                    é«˜ç­‰çº§è®¡ç®—æ€§èƒ½: ${time1.toFixed(2)}ms (ç›®æ ‡: <50ms)
                </div>
                <div class="test-result ${time2 < time1 / 2 ? 'pass' : 'fail'}">
                    ç¼“å­˜æ€§èƒ½æå‡: ${time2.toFixed(2)}ms (æå‡: ${((time1 - time2) / time1 * 100).toFixed(1)}%)
                </div>
                <div class="test-result ${time3 < 20 ? 'pass' : 'fail'}">
                    åå‘æŸ¥æ‰¾æ€§èƒ½: ${time3.toFixed(2)}ms (ç›®æ ‡: <20ms)
                </div>
            `;
        }
    </script>
</body>
</html>