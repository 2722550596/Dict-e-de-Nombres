<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameHUDä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .test-result.pass {
            background: #c6f6d5;
            border-left: 4px solid #38a169;
        }
        
        .test-result.fail {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
        }
        
        .test-result.info {
            background: #bee3f8;
            border-left: 4px solid #3182ce;
        }
        
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #3182ce;
        }
        
        .mock-hud {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            padding: 0.75rem;
            font-size: 14px;
            z-index: 1000;
        }
        
        .mock-hud .level-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .mock-hud .level-icon {
            width: 20px;
            height: 20px;
            background: #fef3c7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #f59e0b;
        }
        
        .mock-hud .exp-bar {
            width: 100px;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .mock-hud .exp-fill {
            height: 100%;
            background: #14b8a6;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ GameHUDä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ§ª GameDataManageræµ‹è¯•</h2>
            <button onclick="testGameDataManager()">æµ‹è¯•GameDataManager</button>
            <div id="gamedata-results"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ“Š ç»éªŒè¿›åº¦è®¡ç®—æµ‹è¯•</h2>
            <button onclick="testExperienceProgress()">æµ‹è¯•ç»éªŒè¿›åº¦</button>
            <div id="progress-results"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ® æ¨¡æ‹ŸHUDæ˜¾ç¤º</h2>
            <button onclick="simulateHUD()">æ¨¡æ‹ŸHUD</button>
            <button onclick="clearMockHUD()">æ¸…é™¤HUD</button>
            <div id="hud-results"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”„ æ•°æ®æ›´æ–°æµ‹è¯•</h2>
            <button onclick="simulateDataUpdate()">æ¨¡æ‹Ÿæ•°æ®æ›´æ–°</button>
            <div id="update-results"></div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹ŸGameDataManagerçš„æ ¸å¿ƒåŠŸèƒ½
        class MockGameDataManager {
            static calculateLevel(experience) {
                const safeExperience = Math.max(0, experience);
                
                if (safeExperience === 0) return 1;
                
                // ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ä¼˜åŒ–æ€§èƒ½
                let left = 1;
                let right = 100;
                let result = 1;
                
                while (left <= right) {
                    const mid = Math.floor((left + right) / 2);
                    const requiredExp = this.getExperienceRequiredForLevel(mid);
                    
                    if (requiredExp <= safeExperience) {
                        result = mid;
                        left = mid + 1;
                    } else {
                        right = mid - 1;
                    }
                }
                
                return result;
            }

            static getExperienceRequiredForLevel(level) {
                const safeLevel = Math.max(1, Math.min(level, 100));
                
                if (safeLevel <= 1) return 0;
                
                let totalExp = 0;
                
                // ç¬¬ä¸€é˜¶æ®µ (2-10çº§): å¿«é€Ÿå‡çº§æœŸ
                for (let i = 2; i <= Math.min(safeLevel, 10); i++) {
                    const expForLevel = Math.floor(100 * Math.pow(1.4, i - 2));
                    totalExp += expForLevel;
                }
                
                // ç¬¬äºŒé˜¶æ®µ (11-30çº§): ç¨³å®šå¢é•¿æœŸ
                if (safeLevel > 10) {
                    for (let i = 11; i <= Math.min(safeLevel, 30); i++) {
                        const additionalLevel = i - 10;
                        const expForLevel = Math.floor(500 * Math.pow(1.3, additionalLevel - 1));
                        totalExp += expForLevel;
                    }
                }
                
                // ç¬¬ä¸‰é˜¶æ®µ (31çº§+): æŒ‘æˆ˜æœŸ
                if (safeLevel > 30) {
                    for (let i = 31; i <= safeLevel; i++) {
                        const additionalLevel = i - 30;
                        const expForLevel = Math.floor(2000 * Math.pow(1.25, additionalLevel - 1));
                        totalExp += expForLevel;
                    }
                }
                
                return totalExp;
            }

            static getExperienceForNextLevel(level) {
                const safeLevel = Math.max(1, Math.min(level, 100));
                
                if (safeLevel >= 100) {
                    return 0;
                }
                
                const currentLevelExp = this.getExperienceRequiredForLevel(safeLevel);
                const nextLevelExp = this.getExperienceRequiredForLevel(safeLevel + 1);
                
                return nextLevelExp - currentLevelExp;
            }

            static getExperienceProgress(experience) {
                const safeExperience = Math.max(0, experience);
                const level = this.calculateLevel(safeExperience);
                
                const currentLevelRequiredExp = this.getExperienceRequiredForLevel(level);
                const nextLevelRequiredExp = this.getExperienceRequiredForLevel(level + 1);
                
                const currentLevelExp = Math.max(0, safeExperience - currentLevelRequiredExp);
                const nextLevelExp = nextLevelRequiredExp - currentLevelRequiredExp;
                
                let progress = 0;
                if (nextLevelExp > 0) {
                    progress = currentLevelExp / nextLevelExp;
                } else {
                    progress = 1;
                }
                
                return {
                    level,
                    currentLevelExp: Math.max(0, currentLevelExp),
                    nextLevelExp: Math.max(0, nextLevelExp),
                    progress: Math.min(1, Math.max(0, progress))
                };
            }

            static loadUserData() {
                const defaultData = {
                    level: 1,
                    experience: 0,
                    totalSessions: 0,
                    todaySessions: 0,
                    lastActiveDate: new Date().toDateString(),
                    totalQuestions: 0,
                    totalCorrect: 0,
                    maxStreak: 0
                };

                try {
                    const saved = localStorage.getItem('test_userData');
                    if (!saved) return defaultData;
                    
                    const data = JSON.parse(saved);
                    return { ...defaultData, ...data };
                } catch (error) {
                    console.error('Failed to load user data:', error);
                    return defaultData;
                }
            }

            static saveUserData(userData) {
                try {
                    localStorage.setItem('test_userData', JSON.stringify(userData));
                    return true;
                } catch (error) {
                    console.error('Failed to save user data:', error);
                    return false;
                }
            }
        }
        
        function testGameDataManager() {
            const resultsDiv = document.getElementById('gamedata-results');
            resultsDiv.innerHTML = '<h3>GameDataManageræµ‹è¯•ç»“æœ</h3>';
            
            const tests = [
                {
                    name: 'loadUserDataåº”è¯¥è¿”å›æœ‰æ•ˆæ•°æ®',
                    test: () => {
                        const userData = MockGameDataManager.loadUserData();
                        return userData && typeof userData.level === 'number' && userData.level >= 1;
                    }
                },
                {
                    name: 'calculateLevelåº”è¯¥æ­£ç¡®è®¡ç®—ç­‰çº§',
                    test: () => {
                        const level1 = MockGameDataManager.calculateLevel(0);
                        const level2 = MockGameDataManager.calculateLevel(100);
                        return level1 === 1 && level2 === 2;
                    }
                },
                {
                    name: 'getExperienceProgressåº”è¯¥è¿”å›æœ‰æ•ˆè¿›åº¦',
                    test: () => {
                        const progress = MockGameDataManager.getExperienceProgress(150);
                        return progress && 
                               typeof progress.level === 'number' &&
                               typeof progress.currentLevelExp === 'number' &&
                               typeof progress.nextLevelExp === 'number' &&
                               typeof progress.progress === 'number' &&
                               progress.progress >= 0 && progress.progress <= 1;
                    }
                },
                {
                    name: 'è´Ÿæ•°ç»éªŒåº”è¯¥è¢«å®‰å…¨å¤„ç†',
                    test: () => {
                        const progress = MockGameDataManager.getExperienceProgress(-100);
                        return progress.level === 1 && progress.currentLevelExp === 0;
                    }
                }
            ];
            
            let passCount = 0;
            tests.forEach(test => {
                try {
                    const passed = test.test();
                    if (passed) passCount++;
                    
                    resultsDiv.innerHTML += `
                        <div class="test-result ${passed ? 'pass' : 'fail'}">
                            ${passed ? 'âœ…' : 'âŒ'} ${test.name}
                        </div>
                    `;
                } catch (error) {
                    resultsDiv.innerHTML += `
                        <div class="test-result fail">
                            âŒ ${test.name} - é”™è¯¯: ${error.message}
                        </div>
                    `;
                }
            });
            
            resultsDiv.innerHTML += `
                <div class="test-result info">
                    <strong>æµ‹è¯•æ€»ç»“ï¼š</strong> ${passCount}/${tests.length} ä¸ªæµ‹è¯•é€šè¿‡
                </div>
            `;
        }
        
        function testExperienceProgress() {
            const resultsDiv = document.getElementById('progress-results');
            resultsDiv.innerHTML = '<h3>ç»éªŒè¿›åº¦æµ‹è¯•ç»“æœ</h3>';
            
            const testExperiences = [0, 50, 100, 150, 500, 1000, -100, null, undefined];
            
            testExperiences.forEach(exp => {
                try {
                    const progress = MockGameDataManager.getExperienceProgress(exp || 0);
                    
                    // å®‰å…¨æ£€æŸ¥ï¼ˆæ¨¡æ‹ŸGameHUDä¸­çš„é€»è¾‘ï¼‰
                    const safeProgress = {
                        level: Math.max(1, progress.level || 1),
                        currentLevelExp: Math.max(0, progress.currentLevelExp || 0),
                        nextLevelExp: Math.max(0, progress.nextLevelExp || 0),
                        progress: Math.min(1, Math.max(0, progress.progress || 0))
                    };
                    
                    const isValid = safeProgress.level >= 1 && 
                                   safeProgress.currentLevelExp >= 0 && 
                                   safeProgress.nextLevelExp >= 0 && 
                                   safeProgress.progress >= 0 && 
                                   safeProgress.progress <= 1;
                    
                    resultsDiv.innerHTML += `
                        <div class="test-result ${isValid ? 'pass' : 'fail'}">
                            ç»éªŒ: ${exp} â†’ ç­‰çº§: ${safeProgress.level}, è¿›åº¦: ${Math.round(safeProgress.progress * 100)}%
                        </div>
                    `;
                } catch (error) {
                    resultsDiv.innerHTML += `
                        <div class="test-result fail">
                            ç»éªŒ: ${exp} â†’ é”™è¯¯: ${error.message}
                        </div>
                    `;
                }
            });
        }
        
        function simulateHUD() {
            clearMockHUD(); // å…ˆæ¸…é™¤ç°æœ‰çš„
            
            const userData = MockGameDataManager.loadUserData();
            const progress = MockGameDataManager.getExperienceProgress(userData.experience);
            
            // å®‰å…¨æ£€æŸ¥
            const safeProgress = {
                level: Math.max(1, progress.level || 1),
                currentLevelExp: Math.max(0, progress.currentLevelExp || 0),
                nextLevelExp: Math.max(0, progress.nextLevelExp || 0),
                progress: Math.min(1, Math.max(0, progress.progress || 0))
            };
            
            const mockHUD = document.createElement('div');
            mockHUD.className = 'mock-hud';
            mockHUD.id = 'mock-hud';
            mockHUD.innerHTML = `
                <div class="level-display">
                    <div class="level-icon">â­</div>
                    <div>
                        <div>ç­‰çº§ ${safeProgress.level}</div>
                        <div style="font-size: 0.8rem; color: #64748b;">
                            ${safeProgress.currentLevelExp}/${safeProgress.nextLevelExp} ç»éªŒ
                        </div>
                    </div>
                </div>
                <div class="exp-bar">
                    <div class="exp-fill" style="width: ${safeProgress.progress * 100}%"></div>
                </div>
            `;
            
            document.body.appendChild(mockHUD);
            
            const resultsDiv = document.getElementById('hud-results');
            resultsDiv.innerHTML = `
                <div class="test-result pass">
                    âœ… æ¨¡æ‹ŸHUDå·²æ˜¾ç¤ºåœ¨å·¦ä¸Šè§’<br>
                    ç­‰çº§: ${safeProgress.level}<br>
                    ç»éªŒ: ${safeProgress.currentLevelExp}/${safeProgress.nextLevelExp}<br>
                    è¿›åº¦: ${Math.round(safeProgress.progress * 100)}%
                </div>
            `;
        }
        
        function clearMockHUD() {
            const existingHUD = document.getElementById('mock-hud');
            if (existingHUD) {
                existingHUD.remove();
            }
        }
        
        function simulateDataUpdate() {
            const resultsDiv = document.getElementById('update-results');
            resultsDiv.innerHTML = '<h3>æ•°æ®æ›´æ–°æ¨¡æ‹Ÿ</h3>';
            
            // æ¨¡æ‹Ÿè·å¾—ç»éªŒ
            const userData = MockGameDataManager.loadUserData();
            const oldLevel = userData.level;
            
            // æ·»åŠ ä¸€äº›ç»éªŒ
            userData.experience += Math.floor(Math.random() * 200) + 50;
            userData.level = MockGameDataManager.calculateLevel(userData.experience);
            
            // ä¿å­˜æ•°æ®
            const saveSuccess = MockGameDataManager.saveUserData(userData);
            
            const newProgress = MockGameDataManager.getExperienceProgress(userData.experience);
            
            resultsDiv.innerHTML += `
                <div class="test-result ${saveSuccess ? 'pass' : 'fail'}">
                    ${saveSuccess ? 'âœ…' : 'âŒ'} æ•°æ®ä¿å­˜: ${saveSuccess ? 'æˆåŠŸ' : 'å¤±è´¥'}
                </div>
                <div class="test-result info">
                    ç­‰çº§å˜åŒ–: ${oldLevel} â†’ ${userData.level}<br>
                    å½“å‰ç»éªŒ: ${userData.experience}<br>
                    å½“å‰è¿›åº¦: ${Math.round(newProgress.progress * 100)}%
                </div>
            `;
            
            // æ›´æ–°æ¨¡æ‹ŸHUDï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const mockHUD = document.getElementById('mock-hud');
            if (mockHUD) {
                simulateHUD();
                resultsDiv.innerHTML += `
                    <div class="test-result info">
                        ğŸ”„ æ¨¡æ‹ŸHUDå·²æ›´æ–°
                    </div>
                `;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è¿è¡ŒåŸºæœ¬æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            console.log('GameHUDä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>