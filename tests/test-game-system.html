<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆç³»ç»Ÿæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .level-progress {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .level-fill {
            background: linear-gradient(90deg, #28a745, #20c997);
            height: 100%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>ğŸ® æ¸¸æˆåŒ–ç³»ç»Ÿæµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š ç»éªŒå€¼è®¡ç®—æµ‹è¯•</h2>
        <button onclick="testExperienceCalculation()">æµ‹è¯•ç»éªŒå€¼è®¡ç®—</button>
        <div id="exp-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ† ç­‰çº§ç³»ç»Ÿæµ‹è¯•</h2>
        <button onclick="testLevelSystem()">æµ‹è¯•ç­‰çº§ç³»ç»Ÿ</button>
        <div id="level-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”¥ è¿å‡»å¥–åŠ±æµ‹è¯•</h2>
        <button onclick="testStreakBonus()">æµ‹è¯•è¿å‡»å¥–åŠ±</button>
        <div id="streak-results"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ æ™ºèƒ½æ¨èæµ‹è¯•</h2>
        <button onclick="testRecommendation()">æµ‹è¯•æ™ºèƒ½æ¨è</button>
        <div id="recommendation-results"></div>
    </div>

    <script>
        // æ¨¡æ‹ŸGameDataManagerçš„æ ¸å¿ƒæ–¹æ³•
        class TestGameDataManager {
            static calculateExperience(sessionResults) {
                const validResults = sessionResults.filter(r => r.userAnswer.trim() !== '');
                if (validResults.length === 0) return 0;

                const correctCount = validResults.filter(r => r.correct).length;
                const totalCount = validResults.length;
                let totalExp = 0;

                validResults.forEach(result => {
                    let baseExp = 5;
                    if (result.mode === 'math' && result.operator) {
                        switch (result.operator) {
                            case '+': baseExp *= 2.5; break;
                            case '-': baseExp *= 3.5; break;
                            case 'Ã—':
                            case 'Ã·': baseExp *= 4; break; // æ–°çš„4å€å€æ•°
                        }
                    }
                    if (result.correct) {
                        totalExp += baseExp;
                    }
                });

                const accuracy = correctCount / totalCount;
                const accuracyBonus = Math.floor(accuracy * totalCount * 10);
                const streak = this.calculateStreak(sessionResults.map(r => r.correct));
                const streakBonus = this.calculateStreakBonus(streak);

                return Math.round(totalExp + accuracyBonus + streakBonus);
            }

            static calculateStreakBonus(streak) {
                if (streak < 3) return 0;
                let bonus = 0;
                
                if (streak >= 3) {
                    const baseStreaks = Math.min(streak, 5) - 2;
                    bonus += baseStreaks * 2;
                }
                if (streak >= 6) {
                    const midStreaks = Math.min(streak, 10) - 5;
                    bonus += midStreaks * 3;
                }
                if (streak >= 11) {
                    const highStreaks = Math.min(streak, 20) - 10;
                    bonus += highStreaks * 5;
                }
                if (streak >= 21) {
                    const maxStreaks = streak - 20;
                    bonus += maxStreaks * 8;
                }
                
                return bonus;
            }

            static calculateStreak(results) {
                let maxStreak = 0;
                let currentStreak = 0;
                
                for (const isCorrect of results) {
                    if (isCorrect) {
                        currentStreak++;
                        maxStreak = Math.max(maxStreak, currentStreak);
                    } else {
                        currentStreak = 0;
                    }
                }
                
                return maxStreak;
            }

            static calculateLevel(experience) {
                const safeExperience = Math.max(0, experience);

                let currentExp = 0;
                let level = 1;
                let expForNextLevel = 150;

                while (currentExp + expForNextLevel <= safeExperience) {
                    currentExp += expForNextLevel;
                    level++;
                    expForNextLevel = 150 + (level - 2) * 50;

                    if (level > 100) break;
                }

                return level;
            }

            static getExperienceProgress(experience) {
                const safeExperience = Math.max(0, experience);
                const level = this.calculateLevel(safeExperience);

                const currentLevelRequiredExp = this.getExperienceRequiredForLevel(level);
                const nextLevelRequiredExp = this.getExperienceRequiredForLevel(level + 1);

                const currentLevelExp = Math.max(0, safeExperience - currentLevelRequiredExp);
                const nextLevelExp = nextLevelRequiredExp - currentLevelRequiredExp;

                let progress = 0;
                if (nextLevelExp > 0) {
                    progress = currentLevelExp / nextLevelExp;
                } else {
                    progress = 1;
                }

                return {
                    level,
                    currentLevelExp: Math.max(0, currentLevelExp),
                    nextLevelExp: Math.max(0, nextLevelExp),
                    progress: Math.min(1, Math.max(0, progress))
                };
            }

            static getExperienceRequiredForLevel(level) {
                const safeLevel = Math.max(1, level);
                if (safeLevel <= 1) return 0;

                let totalExp = 0;
                for (let i = 2; i <= safeLevel; i++) {
                    totalExp += 150 + (i - 2) * 50;
                    if (i > 100) break;
                }

                return totalExp;
            }
        }

        function testExperienceCalculation() {
            const results = document.getElementById('exp-results');
            results.innerHTML = '';

            // æµ‹è¯•æ¡ˆä¾‹
            const testCases = [
                {
                    name: 'æ•°å­—å¬å†™ - å…¨å¯¹',
                    data: [
                        {number: 1, correct: true, userAnswer: '1', mode: 'number'},
                        {number: 2, correct: true, userAnswer: '2', mode: 'number'},
                        {number: 3, correct: true, userAnswer: '3', mode: 'number'}
                    ]
                },
                {
                    name: 'æ•°å­¦è¿ç®— - ä¹˜æ³•å…¨å¯¹',
                    data: [
                        {number: 6, correct: true, userAnswer: '6', mode: 'math', operator: 'Ã—'},
                        {number: 8, correct: true, userAnswer: '8', mode: 'math', operator: 'Ã—'}
                    ]
                },
                {
                    name: 'æ•°å­¦è¿ç®— - é™¤æ³•å…¨å¯¹',
                    data: [
                        {number: 4, correct: true, userAnswer: '4', mode: 'math', operator: 'Ã·'},
                        {number: 6, correct: true, userAnswer: '6', mode: 'math', operator: 'Ã·'}
                    ]
                }
            ];

            testCases.forEach(testCase => {
                const exp = TestGameDataManager.calculateExperience(testCase.data);
                results.innerHTML += `
                    <div class="test-result success">
                        <strong>${testCase.name}</strong><br>
                        è·å¾—ç»éªŒå€¼: ${exp}
                    </div>
                `;
            });
        }

        function testLevelSystem() {
            const results = document.getElementById('level-results');
            results.innerHTML = '';

            // åŒ…å«è¾¹ç•Œæƒ…å†µçš„æµ‹è¯•
            const testExperiences = [-10, 0, 149, 150, 349, 350, 599, 600, 899, 900, 1250, 1650, 2100];

            testExperiences.forEach(exp => {
                const level = TestGameDataManager.calculateLevel(exp);
                const progress = TestGameDataManager.getExperienceProgress(exp);

                const resultClass = progress.currentLevelExp < 0 ? 'test-result error' : 'test-result info';

                results.innerHTML += `
                    <div class="${resultClass}">
                        <strong>ç»éªŒå€¼: ${exp}</strong><br>
                        ç­‰çº§: ${level}<br>
                        å½“å‰ç­‰çº§ç»éªŒ: ${progress.currentLevelExp}/${progress.nextLevelExp}<br>
                        è¿›åº¦: ${Math.round(progress.progress * 100)}%
                        <div class="level-progress">
                            <div class="level-fill" style="width: ${progress.progress * 100}%"></div>
                        </div>
                    </div>
                `;
            });
        }

        function testStreakBonus() {
            const results = document.getElementById('streak-results');
            results.innerHTML = '';

            const testStreaks = [1, 3, 5, 10, 15, 25, 50];
            
            testStreaks.forEach(streak => {
                const bonus = TestGameDataManager.calculateStreakBonus(streak);
                results.innerHTML += `
                    <div class="test-result ${bonus > 0 ? 'success' : 'info'}">
                        <strong>${streak}è¿å‡»</strong> â†’ å¥–åŠ±ç»éªŒ: ${bonus}
                    </div>
                `;
            });
        }

        function testRecommendation() {
            const results = document.getElementById('recommendation-results');
            results.innerHTML = `
                <div class="test-result info">
                    <strong>æ™ºèƒ½æ¨èç³»ç»Ÿå·²æ›´æ–°</strong><br>
                    æ–°å¢èŒƒå›´åŒ…æ‹¬ï¼š<br>
                    â€¢ åŸºç¡€: 0-9, 0-16, 0-20, 0-30<br>
                    â€¢ ä¸­çº§: 0-50, 20-69, 50-99, 70-99, 0-99<br>
                    â€¢ å›°éš¾: 100-199, 100-999, 200-999, 1000-1999, 1000-9999<br>
                    â€¢ ç‰¹æ®Š: å¹´ä»½(1700-2050)
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæ‰€æœ‰æµ‹è¯•
        window.onload = function() {
            testExperienceCalculation();
            testLevelSystem();
            testStreakBonus();
            testRecommendation();
        };
    </script>
</body>
</html>
